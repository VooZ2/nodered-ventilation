[
    {
        "id": "7901ee0f1259f9cf",
        "type": "tab",
        "label": "Komfovent - Module: Auto-Learning",
        "disabled": false,
        "info": ""
    },
    {
        "id": "aed1f77d4fa4a6cc",
        "type": "inject",
        "z": "7901ee0f1259f9cf",
        "name": "Scheduler: Log CO2 (10 min)",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "600",
        "crontab": "",
        "once": true,
        "onceDelay": 2,
        "topic": "co2_sample",
        "payload": "",
        "payloadType": "date",
        "x": 170,
        "y": 100,
        "wires": [
            [
                "c8515b06d019b69a"
            ]
        ]
    },
    {
        "id": "c8515b06d019b69a",
        "type": "function",
        "z": "7901ee0f1259f9cf",
        "name": "Log CO2 Sample",
        "func": "// ===== COâ‚‚ log kaupimas + learning snapshot record =====\n// - Skaito iÅ¡ HA global cache\n// - Ä® flow.co2_log (retention ~10 d) kaupia tik taÅ¡kus: {ts, val, alarm}\n// - Sugeneruoja Ä¯raÅ¡Ä… Logging moduliui: msg.log_type='learning', msg.log_record={module,kind,...}\n\nconst TZ = 'Europe/Vilnius';\n\nfunction isBad(v) {\n  if (v === null || v === undefined) return true;\n  const s = String(v).toLowerCase();\n  return (s === 'unknown' || s === 'unavailable' || s === '');\n}\nfunction isNum(v) { return v !== null && v !== undefined && isFinite(v); }\nfunction clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }\n\nfunction ltIso(date) {\n  return new Intl.DateTimeFormat('sv-SE', {\n    timeZone: TZ,\n    year: 'numeric', month: '2-digit', day: '2-digit',\n    hour: '2-digit', minute: '2-digit', second: '2-digit',\n    hour12: false\n  }).format(date).replace(' ', 'T');\n}\nfunction ltDow(date) {\n  return new Intl.DateTimeFormat('en-US', { timeZone: TZ, weekday: 'short' }).format(date);\n}\nfunction ltHour(date) {\n  return Number(new Intl.DateTimeFormat('en-GB', { timeZone: TZ, hour: '2-digit', hour12: false }).format(date));\n}\n\n// ===== HA cache (robust) =====\nlet ha = global.get('homeassistant') || {};\nlet states =\n  (ha?.homeAssistant?.states) ||\n  (ha?.homeassistant?.states) ||\n  (ha?.states) ||\n  {};\n\nconst ENT = {\n  alarm: 'alarm_control_panel.home',\n  co2: 'sensor.oro_stotele_carbon_dioxide',\n  mode: 'sensor.komfovent_logic_2',\n  boost: 'binary_sensor.komfovent_rate_boost_nr',\n  outdoor: 'sensor.boiler_outside_temperature',\n  humidity: 'sensor.bathroom_humidity',\n  fan_actual: 'sensor.intake_fan_level_current',\n  recup: 'switch.start_stop'\n};\n\nconst nowDate = new Date();\nconst ts = ltIso(nowDate);\nconst nowMs = nowDate.getTime();\n\n// Alarm\nconst alarmRaw = states?.[ENT.alarm]?.state;\nlet alarm_state = isBad(alarmRaw) ? (flow.get('alarm_last_known') || null) : String(alarmRaw);\nif (alarm_state) flow.set('alarm_last_known', alarm_state);\n\nconst occupied = (String(alarm_state || '') === 'disarmed');\nconst dow = ltDow(nowDate);\nconst hour = ltHour(nowDate);\n\n// CO2\nconst co2Raw = states?.[ENT.co2]?.state;\nconst co2Val = isBad(co2Raw) ? null : parseFloat(co2Raw);\nif (!isNum(co2Val)) {\n  node.status({ fill: 'red', shape: 'ring', text: `CO2 invalid: ${String(co2Raw)}` });\n  return null;\n}\nconst co2 = Math.round(co2Val);\n\n// Mode (source of truth)\nconst modeRaw = states?.[ENT.mode]?.state;\nlet mode = isBad(modeRaw) ? (flow.get('mode_last_known') || null) : String(modeRaw);\nif (mode) flow.set('mode_last_known', mode);\n\n// Recup ON?\nconst recupIsOn = (String(states?.[ENT.recup]?.state || '').toLowerCase() === 'on');\n\n// Fan actual (0% logic)\nconst fanRaw = states?.[ENT.fan_actual]?.state;\nlet fan_actual = parseFloat(fanRaw);\n\nif (!isFinite(fan_actual)) {\n  fan_actual = null;\n} else if (fan_actual === 0 || recupIsOn === false) {\n  fan_actual = 0;\n} else {\n  fan_actual = clamp(Math.round(fan_actual), 20, 100);\n}\n\n// Boost (internal)\nconst boostRaw = String(states?.[ENT.boost]?.state || '').toLowerCase();\nconst boost_active = (boostRaw === 'on' || boostRaw === 'true');\n\n// Outdoor / Humidity\nconst outdoorRaw = states?.[ENT.outdoor]?.state;\nconst outdoor = isBad(outdoorRaw) ? null : parseFloat(outdoorRaw);\n\nconst humidityRaw = states?.[ENT.humidity]?.state;\nconst humidity = isBad(humidityRaw) ? null : parseFloat(humidityRaw);\n\nconst windows_long_open = !!flow.get('windows_long_open');\n\n// ===== co2_log retention (~10 d) =====\nlet logs = flow.get('co2_log');\nif (!Array.isArray(logs)) logs = [];\n\nlogs.push({ ts: nowMs, val: co2, alarm: String(alarm_state || '') });\n\n// geresnÄ— retention pagal laikÄ… (10 d)\nconst KEEP_MS = 10 * 24 * 60 * 60 * 1000;\nlogs = logs.filter(p => isNum(p?.ts) && (nowMs - p.ts) <= KEEP_MS);\n\nflow.set('co2_log', logs);\n\nnode.status({\n  fill: 'green',\n  shape: 'dot',\n  text: `CO2 ${co2} | pts ${logs.length} | fan ${fan_actual ?? 'n/a'}% | alarm ${alarm_state || ''}`\n});\n\n// ===== record Ä¯ Logging modulÄ¯ =====\nmsg.log_type = 'learning';\nmsg.log_record = {\n  module: 'learning',\n  kind: 'snapshot',\n\n  ts,\n  occupied,\n  alarm_state,\n  dow,\n  hour,\n\n  mode: mode,\n\n  // bendras fan laukelis â€“ predictiveâ€™ui patogiau\n  fan: (fan_actual === null ? null : fan_actual),\n  co2,\n  rate: null,\n  boost_active,\n  outdoor: isFinite(outdoor) ? Number(outdoor.toFixed(1)) : null,\n  humidity: isFinite(humidity) ? Number(humidity.toFixed(1)) : null,\n  windows_long_open,\n\n  // learning specifika\n  event: 'co2_sample',\n  fan_actual\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 430,
        "y": 100,
        "wires": [
            [
                "98b56b9dbb7ff1bd",
                "12dd9ef407ac43d7"
            ]
        ]
    },
    {
        "id": "12dd9ef407ac43d7",
        "type": "debug",
        "z": "7901ee0f1259f9cf",
        "name": "Debug (optional): learning snapshot",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "log_record",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 340,
        "y": 160,
        "wires": []
    },
    {
        "id": "36eb7a4cd99381e7",
        "type": "inject",
        "z": "7901ee0f1259f9cf",
        "name": "Scheduler: Threshold Update (03:00 LT)",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "00 03 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "threshold_update",
        "payload": "",
        "payloadType": "date",
        "x": 200,
        "y": 220,
        "wires": [
            [
                "3df2171f561b0c8f"
            ]
        ]
    },
    {
        "id": "3df2171f561b0c8f",
        "type": "function",
        "z": "7901ee0f1259f9cf",
        "name": "Compute Threshold & Guards",
        "func": "/*************************************************\n * COâ‚‚ THRESHOLD COMPUTE (v4.3.0 GOLD - STEP 1)\n * - Step 1 (HA input_number priima integer step=1)\n * - Apsaugos: ALARM / GAP / STABILITY\n * - Logging per Logging modulÄ¯: msg.log_type='learning', msg.log_record=object\n * - Standartai:\n *   â€¢ schema_ver ir flow_ver nehardcodinam (ateina per Logging Normalize Record)\n *   â€¢ ts â€“ LT ISO su sekundÄ—mis (sv-SE + Europe/Vilnius), kaip kituose loguose\n *   â€¢ visada pridedam module/kind, dow/hour, alarm_state, mode (jei turim)\n *************************************************/\n\nconst TZ = 'Europe/Vilnius';\n\nconst SAMPLE_MIN = 10;\nconst STABILITY_MAX_MIN = 650;\nconst STABILITY_RANGE_MIN = 100;\nconst GAP_MISSING_MAX = 0.35;\n\nconst TARGET_RATE = 60;   // ppm/h\nconst K = 0.2;\nconst DELTA_MAX = 25;\n\nconst THRESH_MIN = 400;\nconst THRESH_MAX = 1200;\n\nconst ENT = {\n  alarm: 'alarm_control_panel.home',\n  thresh: 'input_number.co2_on_threshold',\n  mode: 'sensor.komfovent_logic_2' // source of truth (jei egzistuoja)\n};\n\nfunction isBad(v) {\n  if (v === null || v === undefined) return true;\n  const s = String(v).toLowerCase();\n  return (s === 'unknown' || s === 'unavailable' || s === '');\n}\nfunction isNum(v) { return v !== null && v !== undefined && isFinite(v); }\nfunction clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }\n\nfunction ltIso(date) {\n  return new Intl.DateTimeFormat('sv-SE', {\n    timeZone: TZ,\n    year: 'numeric', month: '2-digit', day: '2-digit',\n    hour: '2-digit', minute: '2-digit', second: '2-digit',\n    hour12: false\n  }).format(date).replace(' ', 'T');\n}\nfunction ltDow(date) {\n  return new Intl.DateTimeFormat('en-US', { timeZone: TZ, weekday: 'short' }).format(date);\n}\nfunction ltHour(date) {\n  return Number(new Intl.DateTimeFormat('en-GB', { timeZone: TZ, hour: '2-digit', hour12: false }).format(date));\n}\n\n// ===== HA global cache (robust) =====\nlet ha = global.get('homeassistant') || {};\nlet states =\n  (ha?.homeAssistant?.states) ||\n  (ha?.homeassistant?.states) ||\n  (ha?.states) ||\n  {};\n\n// ===== Alarm / occupied =====\nconst alarmRaw = states?.[ENT.alarm]?.state;\nlet alarm = isBad(alarmRaw) ? (flow.get('alarm_last_known') || null) : String(alarmRaw);\nif (alarm) flow.set('alarm_last_known', alarm);\n\nconst occupied = (String(alarm || '') === 'disarmed');\nconst learningBlocked = !occupied;\n\n// ===== Mode (optional, bet naudinga logams) =====\nconst modeRaw = states?.[ENT.mode]?.state;\nlet mode = isBad(modeRaw) ? (flow.get('mode_last_known') || null) : String(modeRaw);\nif (mode) flow.set('mode_last_known', mode);\n\n// ===== Threshold prev =====\nlet threshPrev = parseFloat(states?.[ENT.thresh]?.state);\nif (!isFinite(threshPrev)) threshPrev = 750;\n\n// ===== 24h duomenys =====\nconst nowDate = new Date();\nconst nowMs = nowDate.getTime();\n\nlet logs = flow.get('co2_log');\nif (!Array.isArray(logs)) logs = [];\n\nconst logs24_all = logs.filter(x => isNum(x?.ts) && isNum(x?.val) && x.ts >= (nowMs - 86400000));\nif (logs24_all.length < 10) {\n  node.status({ fill: 'yellow', shape: 'ring', text: `learning skip: logs24_all=${logs24_all.length}` });\n  return null;\n}\n\n// mokomÄ—s tik iÅ¡ disarmed taÅ¡kÅ³\nconst logs24 = logs24_all.filter(x => String(x?.alarm || '') === 'disarmed');\n\n// jei disarmed taÅ¡kÅ³ beveik nÄ—ra, stability skaiÄiavimai bÅ«tÅ³ klaidingi\nif (logs24.length < 2) {\n  const tsLT = ltIso(nowDate);\n  const recSkip = {\n    module: 'learning',\n    kind: 'learning_update',\n    ts: tsLT,\n    occupied,\n    alarm_state: alarm,\n    dow: ltDow(nowDate),\n    hour: ltHour(nowDate),\n\n    mode: mode,\n\n    // diagnostika\n    threshold_prev: Math.round(threshPrev),\n    threshold_new: Math.round(threshPrev),\n    delta: 0,\n\n    avgRate_ppmh: 0,\n    missing_frac: Number(clamp(1 - (logs24_all.length / Math.round(1440 / SAMPLE_MIN)), 0, 1).toFixed(2)),\n    blocked: true,\n    block_reasons: { learningBlocked, gapBlocked: false, stabilityBlocked: false, too_few_disarmed_points: true }\n  };\n\n  flow.set('learning_last_update', recSkip);\n  msg.log_type = 'learning';\n  msg.log_record = recSkip;\n  msg.threshold_changed = false;\n  msg.ha = null;\n\n  node.status({ fill: 'yellow', shape: 'dot', text: 'learning blocked: too few disarmed points' });\n  return msg;\n}\n\n// ===== 2. GAP GUARD =====\nconst expected = Math.round(1440 / SAMPLE_MIN);\nconst missingFrac = clamp(1 - (logs24_all.length / expected), 0, 1);\nconst gapBlocked = (missingFrac > GAP_MISSING_MAX);\n\n// ===== 3. STABILITY GUARD =====\nconst vals = logs24.map(l => l.val);\nconst minCo2 = Math.min(...vals);\nconst maxCo2 = Math.max(...vals);\nconst stabilityBlocked = (maxCo2 < STABILITY_MAX_MIN) || ((maxCo2 - minCo2) < STABILITY_RANGE_MIN);\n\n// ===== 4. CO2 kilimo tempas (ppm/h) =====\nlet sumRate = 0;\nlet cnt = 0;\n\nfor (let i = 1; i < logs24.length; i++) {\n  const dtMin = (logs24[i].ts - logs24[i - 1].ts) / 60000;\n  if (dtMin > 0 && dtMin <= 20) {\n    const dCo2 = logs24[i].val - logs24[i - 1].val;\n    if (dCo2 > 0) {\n      // ppm/h\n      sumRate += (dCo2 / dtMin) * 60;\n      cnt++;\n    }\n  }\n}\n\nconst avgRate = cnt ? (sumRate / cnt) : 0;\n\n// delta: ribojam +/- DELTA_MAX, kad nebÅ«tÅ³ Å¡uoliÅ³\nlet delta = -Math.round((avgRate - TARGET_RATE) * K);\ndelta = clamp(delta, -DELTA_MAX, DELTA_MAX);\n\nconst blocked = gapBlocked || stabilityBlocked || learningBlocked;\n\n// ===== 5. Naujas slenkstis (step=1) =====\nconst prevRounded = Math.round(threshPrev);\nconst threshNew = blocked\n  ? prevRounded\n  : clamp(Math.round(prevRounded + delta), THRESH_MIN, THRESH_MAX);\n\n// ===== 6. IÅ¡vestis HA mazgui =====\nmsg.threshold_changed = (prevRounded !== threshNew);\nmsg.ha = msg.threshold_changed ? { entity_id: ENT.thresh, value: threshNew } : null;\n\n// ===== 7. Unified log record (Ä¯ Logging modulÄ¯) =====\nconst tsLT = ltIso(nowDate);\n\nconst rec = {\n  module: 'learning',\n  kind: 'learning_update',\n\n  ts: tsLT,\n  occupied,\n  alarm_state: alarm,\n  dow: ltDow(nowDate),\n  hour: ltHour(nowDate),\n\n  mode: mode,\n\n  avgRate_ppmh: Number(avgRate.toFixed(1)),\n  missing_frac: Number(missingFrac.toFixed(2)),\n\n  threshold_prev: prevRounded,\n  threshold_new: threshNew,\n  delta: (msg.threshold_changed ? (threshNew - prevRounded) : 0),\n\n  blocked,\n  block_reasons: {\n    learningBlocked,\n    gapBlocked,\n    stabilityBlocked\n  },\n\n  // naudinga diagnostika (neprivaloma predictive, bet praverÄia)\n  stability_min: minCo2,\n  stability_max: maxCo2,\n  points_all_24h: logs24_all.length,\n  points_disarmed_24h: logs24.length\n};\n\nflow.set('learning_last_update', rec);\nmsg.log_record = rec;\nmsg.log_type = 'learning';\n\nnode.status({\n  fill: blocked ? 'yellow' : (msg.threshold_changed ? 'green' : 'blue'),\n  shape: 'dot',\n  text: `delta ${rec.delta} | thr ${threshNew} | miss ${(missingFrac * 100).toFixed(0)}%`\n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 220,
        "wires": [
            [
                "98b56b9dbb7ff1bd",
                "bdff16d6c8b44e6e",
                "gemini_shadow_logic"
            ]
        ]
    },
    {
        "id": "bdff16d6c8b44e6e",
        "type": "switch",
        "z": "7901ee0f1259f9cf",
        "name": "HA Gate: Only When Changed",
        "property": "threshold_changed",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 850,
        "y": 220,
        "wires": [
            [
                "06f76d3d342e4557"
            ]
        ]
    },
    {
        "id": "06f76d3d342e4557",
        "type": "api-call-service",
        "z": "7901ee0f1259f9cf",
        "name": "HA Call: input_number.set_value",
        "server": "de0e06cd.8456e8",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.co2_on_threshold"
        ],
        "labelId": [],
        "data": "{\"value\": {{ha.value}}}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_number",
        "service": "set_value",
        "x": 1150,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "98b56b9dbb7ff1bd",
        "type": "function",
        "z": "7901ee0f1259f9cf",
        "name": "Build Learning Log Record",
        "func": "// Build Learning Log Record -> forwarding Ä¯ Logging modulÄ¯.\n// NeraÅ¡o Ä¯ failÄ… Äia.\n// Output:\n// - msg.log_type = 'learning'\n// - msg.log_record = object (be filename/payload)\n\nconst TZ = 'Europe/Vilnius';\n\nfunction ltIso(date) {\n    return new Intl.DateTimeFormat('sv-SE', {\n        timeZone: TZ,\n        year: 'numeric', month: '2-digit', day: '2-digit',\n        hour: '2-digit', minute: '2-digit', second: '2-digit',\n        hour12: false\n    }).format(date).replace(' ', 'T');\n}\n\nconst rec = msg.log_record;\nif (!rec || typeof rec !== 'object') return null;\n\n// UÅ¾tikrinam log_type (kad upstream netyÄia nepakeistÅ³)\nmsg.log_type = 'learning';\n\n// Minimalus ts fallback (jei upstream jo nepadavÄ—)\nif (!rec.ts || typeof rec.ts !== 'string' || rec.ts.length < 10) {\n    rec.ts = ltIso(new Date());\n}\n\nmsg.log_record = rec;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 100,
        "wires": [
            [
                "4d4e8058983f4673"
            ]
        ]
    },
    {
        "id": "c286335cc8b40d68",
        "type": "link in",
        "z": "7901ee0f1259f9cf",
        "name": "AI In: Learning",
        "links": [
            "567de76b7fee6e80"
        ],
        "x": 95,
        "y": 280,
        "wires": [
            [
                "cf91b3acb12da085"
            ]
        ]
    },
    {
        "id": "cf91b3acb12da085",
        "type": "function",
        "z": "7901ee0f1259f9cf",
        "name": "AI Handler (Learning)",
        "func": "const text = String(msg.text || msg?.payload?.text || '').trim();\nconst t = text.toLowerCase();\n\nlet ha = global.get('homeassistant') || {};\nlet states = (ha?.homeAssistant?.states) || (ha?.homeassistant?.states) || (ha?.states) || {};\n\n// 1. SlenksÄio nustatymas\nconst TH_ENT = 'input_number.co2_on_threshold';\nlet th = parseFloat(states?.[TH_ENT]?.state);\nif (!isFinite(th)) th = Number(global.get('komfovent.auto_co2_on_threshold') || 0) || null;\n\n// 2. Mokymosi duomenys\nconst last = flow.get('learning_last_update') || null;\nconst windows_open = !!flow.get('windows_long_open'); // Papildoma informacija\n\nfunction fmtLast(u) {\n  if (!u) return 'Mokymosi Ä¯raÅ¡Å³ dar nÄ—ra (laukite 03:00 val. analizÄ—s).';\n  let s = `ğŸ“Š PaskutinÄ— analizÄ—: ${u.ts}.\\n`;\n\n  if (u.blocked) {\n    const br = u.block_reasons || {};\n    let why = [];\n    if (br.learningBlocked) why.push('Ä®jungta signalizacija (Armed)');\n    if (br.gapBlocked) why.push('TrÅ«ko duomenÅ³ taÅ¡kÅ³ (>35%)');\n    if (br.stabilityBlocked) why.push('CO2 lygis buvo per stabilus');\n    s += `âŒ Blokuota: ${why.join(', ') || 'neÅ¾inoma prieÅ¾astis'}.`;\n  } else {\n    s += `âœ… Slenkstis pakoreguotas: ${u.threshold_prev} â†’ ${u.threshold_new} ppm (pokytis ${u.delta}).`;\n  }\n  s += `\\nğŸ“… Profilis: ${u.profile}. DuomenÅ³ trÅ«kumas: ${(Number(u.missing_frac || 0) * 100).toFixed(0)}%.`;\n  return s;\n}\n\nlet reply = null;\n\nif (!t) reply = 'Pasiteirauk: \"koks slenkstis\", \"kas su mokymusi\" arba \"profilis\".';\nelse if (t.includes('slenkst') || t.includes('threshold')) {\n  reply = th === null ? 'CO2 slenksÄio reikÅ¡mÄ—s HA nerandu.' : `ğŸ“ Dabartinis COâ‚‚ Ä¯jungimo slenkstis: ${Math.round(th)} ppm.`;\n}\nelse if (t.includes('mokym') || t.includes('learning') || t.includes('kodel') || t.includes('kodÄ—l')) {\n  reply = fmtLast(last);\n  if (windows_open && last?.blocked) reply += '\\nâš ï¸ PastebÄ—ta: langai buvo ilgai atviri, tai galÄ—jo turÄ—ti Ä¯takos.';\n}\nelse if (t.includes('profil')) {\n  reply = last ? `ğŸ“‹ Aktyvus mokymosi profilis: ${last.profile}.` : 'Profilio duomenÅ³ dar nÄ—ra.';\n}\nelse if (t.includes('miss') || t.includes('truk') || t.includes('trÅ«k')) {\n  reply = last ? `ğŸ“‰ DuomenÅ³ trÅ«kumas analizÄ—s metu: ${(Number(last.missing_frac || 0) * 100).toFixed(0)}%.` : 'DuomenÅ³ trÅ«kumo statistikos nÄ—ra.';\n}\nelse {\n  reply = 'Auto-Learning modulis atsako Ä¯: \"slenkstis\", \"mokymasis\", \"profilis\", \"trÅ«kumas\".';\n}\n\nmsg.ai_reply = true;\nmsg.payload = reply;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 280,
        "wires": [
            [
                "db629847ce4e6de4"
            ]
        ]
    },
    {
        "id": "db629847ce4e6de4",
        "type": "link out",
        "z": "7901ee0f1259f9cf",
        "name": "AI Out: Reply",
        "mode": "link",
        "links": [
            "2c73cea35fecb95c"
        ],
        "x": 995,
        "y": 280,
        "wires": []
    },
    {
        "id": "4d4e8058983f4673",
        "type": "link out",
        "z": "7901ee0f1259f9cf",
        "name": "link out 1",
        "mode": "link",
        "links": [
            "b94f8a643031659c"
        ],
        "x": 865,
        "y": 100,
        "wires": []
    },
    {
        "id": "gemini_shadow_logic",
        "type": "function",
        "z": "7901ee0f1259f9cf",
        "name": "Gemini Shadow Analysis",
        "func": "/*************************************************\n * GEMINI SHADOW ANALYSIS\n *************************************************/\n\nconst logs = flow.get('co2_log') || [];\nconst lastUpdate = flow.get('learning_last_update') || {};\nconst API_KEY = (typeof env !== 'undefined' && env.get) ? env.get('GEMINI_API_KEY') : null;\nconst key = API_KEY || flow.get('GEMINI_API_KEY');\n\nif (!key) {\n    node.error(\"GEMINI_API_KEY nerastas!\");\n    return null;\n}\n\n// ParuoÅ¡iame duomenis kompaktiÅ¡kumui\nconst compactLogs = logs.filter((_, i) => i % 2 === 0).map(p => ({\n    t: new Date(p.ts).toLocaleTimeString('lt-LT', { hour: '2-digit', minute: '2-digit' }),\n    v: p.val\n}));\n\n// Suformuojame uÅ¾klausÄ… (sutvarkytos kabutÄ—s pabaigoje)\nconst prompt = `Esi namÅ³ vÄ—dinimo ekspertas. PerÅ¾iÅ«rÄ—k CO2 logus: ${JSON.stringify(compactLogs)}\n\nMatematinis algoritmas siÅ«lo: ${lastUpdate.threshold_new} ppm.\nSenas slenkstis buvo: ${lastUpdate.threshold_prev} ppm.\n\nUÅ½DUOTIS:\n1. Pateik savo rekomendacijÄ… (skaiÄiÅ³).\n2. Trumpai (1-2 sakiniais) paaiÅ¡kink kodÄ—l, nurodydamas skirtumÄ… nuo matematinio skaiÄiavimo.\n3. RaÅ¡yk lietuviÅ¡kai, draugiÅ¡kai, bet labai konkreÄiai. Nevartok jokiÅ³ Ä¯Å¾angÅ³, punktÅ³ ar sÄ…raÅ¡Å³.`;\n\nmsg.url = \"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=\" + key;\nmsg.payload = {\n    contents: [{ parts: [{ text: prompt }] }],\n    generationConfig: {\n        temperature: 0.6,\n        maxOutputTokens: 300\n    }\n};\n\nnode.status({ fill: \"blue\", shape: \"dot\", text: \"SiunÄiama Gemini 2.0...\" });\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 430,
        "y": 360,
        "wires": [
            [
                "gemini_api_call"
            ]
        ]
    },
    {
        "id": "gemini_api_call",
        "type": "http request",
        "z": "7901ee0f1259f9cf",
        "name": "Gemini API Call",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 720,
        "y": 360,
        "wires": [
            [
                "shadow_handler"
            ]
        ]
    },
    {
        "id": "shadow_handler",
        "type": "function",
        "z": "7901ee0f1259f9cf",
        "name": "Shadow Result Handler",
        "func": "// Shadow Result Handler (v4.3.1)\nconst lastUpdate = flow.get('learning_last_update') || {};\n\n// IÅ¡traukiame tekstÄ… iÅ¡ Gemini atsakymo struktÅ«ros\nlet aiResponse = \"Nepavyko gauti atsakymo.\";\nif (msg.payload && msg.payload.candidates && msg.payload.candidates[0].content) {\n    aiResponse = msg.payload.candidates[0].content.parts[0].text;\n} else if (msg.payload && msg.payload.error) {\n    aiResponse = \"API Klaida: \" + msg.payload.error.message;\n}\n\n// IÅ¡saugojam rekomendacijÄ… ateiÄiai\nflow.set('gemini_shadow_recommendation', aiResponse);\n\n// Suformuojam pilnÄ… Å¾inutÄ™ su AI argumentais\nmsg.payload = `ğŸ¤– **Gemini Å eÅ¡Ä—linÄ— AnalizÄ—**\\n` +\n    `ğŸ”¢ Matematinis algoritmas: ${lastUpdate.threshold_new || 'n/a'} ppm\\n\\n` +\n    `${aiResponse}`;\n\nnode.status({ fill: \"green\", shape: \"dot\", text: \"Rekomendacija iÅ¡siÅ³sta\" });\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 360,
        "wires": [
            [
                "db629847ce4e6de4"
            ]
        ]
    },
    {
        "id": "de0e06cd.8456e8",
        "type": "server",
        "name": "Home Assistant",
        "version": 6,
        "addon": false,
        "rejectUnauthorizedCerts": false,
        "ha_boolean": [
            "y",
            "yes",
            "true",
            "on",
            "home",
            "open"
        ],
        "connectionDelay": true,
        "cacheJson": true,
        "heartbeat": false,
        "heartbeatInterval": "30",
        "areaSelector": "friendlyName",
        "deviceSelector": "friendlyName",
        "entitySelector": "friendlyName",
        "statusSeparator": "at: ",
        "statusYear": "hidden",
        "statusMonth": "short",
        "statusDay": "numeric",
        "statusHourCycle": "h23",
        "statusTimeFormat": "h:m",
        "enableGlobalContextStore": true
    },
    {
        "id": "3870b9267924602f",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-home-assistant-websocket": "0.80.3"
        }
    }
]