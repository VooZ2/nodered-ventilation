[
    {
        "id": "c16e5224b33b730b",
        "type": "tab",
        "label": "Komfovent - Module: Auto-Learning",
        "disabled": false,
        "info": "Sampling (10 min) + 03:00 Threshold Update (HA sync) + Daily Audit (telemetry/control/predictive) + AI reply."
    },
    {
        "id": "cec3be0df19147e8",
        "type": "inject",
        "z": "c16e5224b33b730b",
        "name": "Scheduler: CO2 Sample (10 min)",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "600",
        "crontab": "",
        "once": true,
        "onceDelay": 2,
        "topic": "co2_sample",
        "payloadType": "date",
        "x": 200,
        "y": 40,
        "wires": [
            [
                "85994e548f657a78"
            ]
        ]
    },
    {
        "id": "85994e548f657a78",
        "type": "function",
        "z": "c16e5224b33b730b",
        "name": "Learning: CO2 Sample",
        "func": "// CO2 sample (10 min)\n// - Robust HA cache nuskaitymas\n// - Flow co2_log (iki 10 dienų @10 min = 1440 įrašų)\n// - Global last_co2 cache (Predictive patogumui)\n// - Log record -> Logging modulis (schema/versijas uždės Logging Normalize)\n\nconst TZ = 'Europe/Vilnius';\nconst ents = global.get('komfovent_entities') || {};\n\nlet ha = global.get('homeassistant') || {};\nlet states =\n  (ha?.homeAssistant?.states) ||\n  (ha?.homeassistant?.states) ||\n  (ha?.states) ||\n  {};\n\nfunction isBad(v){\n  if (v === null || v === undefined) return true;\n  const s = String(v).trim().toLowerCase();\n  return (s === '' || s === 'unknown' || s === 'unavailable' || s === 'nan');\n}\nfunction isNum(v){ return v !== null && v !== undefined && Number.isFinite(Number(v)); }\nfunction numOrNull(v){ const n = Number(v); return Number.isFinite(n) ? n : null; }\nfunction ltIso(date){\n  return new Intl.DateTimeFormat('sv-SE', {\n    timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit',\n    hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false\n  }).format(date).replace(' ', 'T');\n}\n\nconst ENT = {\n  alarm: ents.alarm || 'alarm_control_panel.home',\n  co2: ents.co2 || 'sensor.oro_stotele_carbon_dioxide',\n  mode: ents.mode || 'sensor.komfovent_logic_2',\n  hood_power: ents.hood_power || 'sensor.hood_socket_power'\n};\n\nconst now = new Date();\nconst ts = ltIso(now);\n\n// alarm su fallback\nlet alarmState = isBad(states?.[ENT.alarm]?.state) ? (flow.get('alarm_last_known') || null) : String(states[ENT.alarm].state);\nif (alarmState) flow.set('alarm_last_known', alarmState);\n\n// mode su fallback\nlet mode = isBad(states?.[ENT.mode]?.state) ? (flow.get('mode_last_known') || null) : String(states[ENT.mode].state);\nif (mode) flow.set('mode_last_known', mode);\n\n// co2\nconst co2Raw = states?.[ENT.co2]?.state;\nconst co2 = (!isBad(co2Raw) && isNum(co2Raw)) ? Math.round(Number(co2Raw)) : null;\n\n// jei co2 nevalidus – fiksuojam seriją (diagnostikai) ir praleidžiam ciklą\nlet invalidStreak = Number(flow.get('co2_invalid_streak') || 0);\nif (!isNum(co2) || co2 < 300) {\n  invalidStreak += 1;\n  flow.set('co2_invalid_streak', invalidStreak);\n  if (invalidStreak >= 3) {\n    node.status({ fill: 'yellow', shape: 'ring', text: `CO₂ nevalidus ${invalidStreak} kart.` });\n  } else {\n    node.status({ fill: 'grey', shape: 'ring', text: `CO₂ nevalidus (${invalidStreak})` });\n  }\n  return null;\n}\nflow.set('co2_invalid_streak', 0);\n\n\n// gartraukio būsena (light-only ignoruojama)\nconst hoodRaw = states?.[ENT.hood_power]?.state;\nconst hoodP = (!isBad(hoodRaw) && isNum(hoodRaw)) ? Number(hoodRaw) : 0;\nconst hoodActive = (Number.isFinite(hoodP) && hoodP >= 75);\n\n// trumpas post-run efektas (kad cooking epizodai neiškreiptų slenksčio)\nconst hoodOffTs = flow.get('hood_off_ts') || 0;\nif (!hoodActive && (flow.get('hood_active_last') === true)) {\n  flow.set('hood_off_ts', now.getTime());\n}\nflow.set('hood_active_last', hoodActive);\n\nconst hoodEffect = hoodActive || (hoodOffTs && (now.getTime() - hoodOffTs) < (10 * 60 * 1000));\n\n\n// flow co2_log\nlet logs = flow.get('co2_log');\nif (!Array.isArray(logs)) logs = [];\nlogs.push({ ts: now.getTime(), val: co2, alarm: alarmState, hood_active: hoodActive, hood_effect: hoodEffect });\nwhile (logs.length > 1440) logs.shift();\nflow.set('co2_log', logs);\n\n// global last\nglobal.set('komfovent.last_co2', co2);\nglobal.set('komfovent.last_co2_ts', now.getTime());\n\nmsg.log_type = 'learning';\nmsg.log_record = {\n  module: 'learning',\n  kind: 'snapshot',\n  ts,\n  occupied: (String(alarmState) === 'disarmed'),\n  alarm_state: alarmState,\n  dow: new Intl.DateTimeFormat('en-US', { timeZone: TZ, weekday:'short' }).format(now),\n  hour: Number(new Intl.DateTimeFormat('en-GB', { timeZone: TZ, hour:'2-digit', hour12:false }).format(now)),\n  mode: mode || null,\n  co2,\n  hood_active: hoodActive,\n  hood_effect: hoodEffect,\n  hood_power_w: Math.round(hoodP),\n  event: 'co2_sample'\n};\n\nnode.status({ fill: 'blue', shape: 'dot', text: `co2 ${co2} | alarm ${alarmState || 'n/a'} | mode ${mode || 'n/a'}${hoodActive ? ` | hood L${(hoodP>=145)?3:(hoodP>=105)?2:1}` : ''}` });\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 480,
        "y": 40,
        "wires": [
            [
                "6e97cc09e127b287"
            ]
        ]
    },
    {
        "id": "6e97cc09e127b287",
        "type": "link out",
        "z": "c16e5224b33b730b",
        "name": "Log Out: Learning",
        "mode": "link",
        "links": [
            "b94f8a643031659c"
        ],
        "x": 645,
        "y": 40,
        "wires": []
    },
    {
        "id": "1882326f953f7e9b",
        "type": "inject",
        "z": "c16e5224b33b730b",
        "name": "Scheduler: 03:00 Nightly",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "00 03 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "nightly",
        "payloadType": "date",
        "x": 170,
        "y": 100,
        "wires": [
            [
                "78411d3197e72128"
            ]
        ]
    },
    {
        "id": "78411d3197e72128",
        "type": "function",
        "z": "c16e5224b33b730b",
        "name": "Learning: Compute Threshold",
        "func": "// 03:00 Threshold update (paprasta, bet stabili heuristika)\n// - Naudoja flow.co2_log\n// - Skaičiuoja p95 iš occupied=true įrašų\n// - Guard: clamp 650..1100, step limit +/-50 per dieną\n// - Nustato global.komfovent.auto_co2_on_threshold\n// - msg.threshold_changed + msg.ha.value HA sync'ui\n// - Log record (learning_update)\n\nconst TZ = 'Europe/Vilnius';\n\nfunction ltIso(d){\n  return new Intl.DateTimeFormat('sv-SE', {\n    timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit',\n    hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false\n  }).format(d).replace(' ', 'T');\n}\nfunction clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }\nfunction isNum(v){ return v !== null && v !== undefined && Number.isFinite(Number(v)); }\n\nconst now = new Date();\nconst ts = ltIso(now);\n\nlet logs = flow.get('co2_log');\nif (!Array.isArray(logs) || logs.length < 20) {\n  msg.threshold_changed = false;\n  msg.ha = { value: null };\n  msg.log_type = 'learning';\n  msg.log_record = {\n    module: 'learning',\n    kind: 'learning_update',\n    ts,\n    event: 'threshold_update',\n    note: 'insufficient co2_log'\n  };\n  node.status({ fill:'yellow', shape:'dot', text:'03:00 threshold: insufficient co2_log' });\n  return msg;\n}\n\nconst occupiedSamples = logs\n  .filter(p => p && isNum(p.val) && String(p.alarm) === 'disarmed' && p.hood_effect !== true)\n  .map(p => Number(p.val));\n\nif (occupiedSamples.length < 20) {\n  msg.threshold_changed = false;\n  msg.ha = { value: null };\n  msg.log_type = 'learning';\n  msg.log_record = {\n    module: 'learning',\n    kind: 'learning_update',\n    ts,\n    event: 'threshold_update',\n    note: 'insufficient occupied samples'\n  };\n  node.status({ fill:'yellow', shape:'dot', text:'03:00 threshold: insufficient occupied samples' });\n  return msg;\n}\n\noccupiedSamples.sort((a,b)=>a-b);\nconst idx95 = Math.floor(0.95 * (occupiedSamples.length - 1));\nconst p95 = occupiedSamples[idx95];\n\nconst prev = Number(global.get('komfovent.auto_co2_on_threshold') || 750);\nlet next = clamp(Math.round(p95), 650, 1100);\n\n// step guard\nconst maxStep = 50;\nif (next > prev + maxStep) next = prev + maxStep;\nif (next < prev - maxStep) next = prev - maxStep;\n\nconst changed = (Math.abs(next - prev) >= 5);\n\n// publish\nif (changed) global.set('komfovent.auto_co2_on_threshold', next);\n\nmsg.threshold_changed = changed;\nmsg.ha = { value: next };\n\nmsg.log_type = 'learning';\nmsg.log_record = {\n  module: 'learning',\n  kind: 'learning_update',\n  ts,\n  event: 'threshold_update',\n  prev_threshold: prev,\n  new_threshold: next,\n  changed,\n  n_total: logs.length,\n  n_occupied: occupiedSamples.length,\n  p95\n};\n\nnode.status({ fill: changed ? 'green' : 'blue', shape:'dot', text:`03:00 threshold ${prev} -> ${next} (${changed?'changed':'same'})` });\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 440,
        "y": 100,
        "wires": [
            [
                "6e97cc09e127b287",
                "028e8f2ad723dc99"
            ]
        ]
    },
    {
        "id": "028e8f2ad723dc99",
        "type": "switch",
        "z": "c16e5224b33b730b",
        "name": "HA Gate: Threshold Changed",
        "property": "threshold_changed",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 730,
        "y": 100,
        "wires": [
            [
                "b7c1af465692f1b8"
            ]
        ]
    },
    {
        "id": "b7c1af465692f1b8",
        "type": "api-call-service",
        "z": "c16e5224b33b730b",
        "name": "HA Call: input_number.set_value",
        "server": "de0e06cd.8456e8",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.co2_on_threshold"
        ],
        "labelId": [],
        "data": "{\"value\": {{ha.value}}}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_number",
        "service": "set_value",
        "x": 1030,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "de0e06cd.8456e8",
        "type": "server",
        "name": "Home Assistant",
        "version": 6,
        "addon": false,
        "rejectUnauthorizedCerts": false,
        "ha_boolean": [
            "y",
            "yes",
            "true",
            "on",
            "home",
            "open"
        ],
        "connectionDelay": true,
        "cacheJson": true,
        "heartbeat": false,
        "heartbeatInterval": "30",
        "areaSelector": "friendlyName",
        "deviceSelector": "friendlyName",
        "entitySelector": "friendlyName",
        "statusSeparator": "at: ",
        "statusYear": "hidden",
        "statusMonth": "short",
        "statusDay": "numeric",
        "statusHourCycle": "h23",
        "statusTimeFormat": "h:m",
        "enableGlobalContextStore": true
    },
    {
        "id": "18a25e34dc5b62c0",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-home-assistant-websocket": "0.80.3"
        }
    }
]