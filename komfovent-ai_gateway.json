[
    {
        "id": "8e4fe2eda5888688",
        "type": "tab",
        "label": "Komfovent: Module - AI Gateway",
        "disabled": false,
        "info": ""
    },
    {
        "id": "98016141e13116ae",
        "type": "telegram receiver",
        "z": "8e4fe2eda5888688",
        "name": "Telegram In",
        "bot": "tg_bot_cfg_komfovent",
        "saveDataDir": "",
        "filterCommands": false,
        "hasinput": false,
        "inputs": 0,
        "handleallupdates": false,
        "x": 120,
        "y": 100,
        "wires": [
            [
                "0fef73201f0874fd"
            ],
            []
        ]
    },
    {
        "id": "0fef73201f0874fd",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "ID Filter & Text Prep",
        "func": "const ALLOWED = Number(env.get(\"MY_TELEGRAM_ID\")) || global.get(\"ALLOWED_TELEGRAM_ID\");\nconst chatId = msg.payload?.chatId;\n\nif (chatId !== ALLOWED) {\n  node.status({ fill: \"red\", shape: \"ring\", text: \"Blokuota: \" + chatId });\n  return null;\n}\n\nmsg.user_text = String(msg.payload?.content || \"\").trim();\nmsg.chatId = chatId;\n\nnode.status({ fill: \"green\", shape: \"dot\", text: \"Vartotojas OK\" });\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 100,
        "wires": [
            [
                "a50a0fdcbc0bef7b"
            ]
        ]
    },
    {
        "id": "a50a0fdcbc0bef7b",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Classify (slash only)",
        "func": "const t = (msg.user_text || '').trim();\nconst tl = t.toLowerCase();\n\n// Visi quick statusai tik su / (kad 'co2' netapt≈≥ statusu)\nlet intent = 'ai';\n\nif (tl === '/start' || tl === '/help' || tl === '/h') intent = 'help';\nelse if (tl === '/status') intent = 'status';\nelse if (tl === '/co2') intent = 'co2';\nelse if (tl === '/fan') intent = 'fan';\nelse if (tl === '/mode') intent = 'mode';\nelse if (tl === '/boost') intent = 'boost';\nelse if (tl === '/humidity') intent = 'humidity';\nelse if (tl === '/outdoor') intent = 'outdoor';\n\nmsg.intent = intent;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 610,
        "y": 100,
        "wires": [
            [
                "8a99dda622ad0827"
            ]
        ]
    },
    {
        "id": "8a99dda622ad0827",
        "type": "switch",
        "z": "8e4fe2eda5888688",
        "name": "Route intent",
        "property": "intent",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "help",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "status",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "co2",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "fan",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "mode",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "boost",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "humidity",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "outdoor",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 9,
        "x": 130,
        "y": 260,
        "wires": [
            [
                "2eeb0466849204e1"
            ],
            [
                "e3d278f60536fd9a"
            ],
            [
                "b84df77aa2da338b"
            ],
            [
                "229a694dd09ee7bf"
            ],
            [
                "4fc293b2c5491c15"
            ],
            [
                "96f187848d8265a5"
            ],
            [
                "0f5a16a27ea026ce"
            ],
            [
                "6bf4d7426e46a7c4"
            ],
            [
                "1d2cc3a20712209c",
                "567de76b7fee6e80"
            ]
        ]
    },
    {
        "id": "2eeb0466849204e1",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Reply: Help",
        "func": "msg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: [\n        'üå¨Ô∏è Komfovent AI Gateway v5.2.0 (Phase B)',\n        '',\n        'üìç Pagrindinƒós komandos:',\n        '/status - Vis≈≥ parametr≈≥ suvestinƒó realiu laiku',\n        '/co2 - Dabartinƒó CO‚ÇÇ koncentracija (ppm)',\n        '/fan - Ventiliatori≈≥ greitis',\n        '/mode - Aktyvus loginis re≈æimas (Naktis, Diena, I≈°vykƒô)',\n        '/humidity - Vonios drƒógmƒós lygis (%)',\n        '',\n        'üìä Predictive v5 (Statistinis Intelektas):',\n        '/shadow - Rizika, prognozƒó ir Z-score nuokrypis nuo istorinƒós normos',\n        '/matrix - Matricos branda (dienos, coverage) ir pasitikƒójimo lygis',\n        '',\n        'üß† Laisvos u≈æklausos (Gemini AI):',\n        '‚Ä¢ \"atlik vakar dienos auditƒÖ\" ‚Äì pilna paros analizƒó',\n        '‚Ä¢ \"paai≈°kink kodƒól fan 45%?\" ‚Äì log≈≥ interpretacija',\n        '‚Ä¢ \"ar filtrai dar geri?\" ‚Äì filtr≈≥ resurs≈≥ patikra',\n        '',\n        'üí° DI sprendimai dabar remiasi 45 dien≈≥ elgsenos matrica.'\n    ].join('\\n')\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 200,
        "wires": [
            [
                "3b5646a6b3bbfec3"
            ]
        ]
    },
    {
        "id": "e3d278f60536fd9a",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Reply: Status",
        "func": "let ha = global.get('homeassistant') || {};\nlet states = ha.states || ha.homeAssistant?.states || {};\nconst ents = global.get('komfovent_entities') || {};\n\nfunction getVal(id, unit = '', dec = 0) {\n    const s = states[id]?.state;\n    const v = parseFloat(s);\n    return isFinite(v) ? v.toFixed(dec) + unit : 'n/a';\n}\n\n// Grie≈ætos dvi fazƒós pagal j≈´s≈≥ nurodymƒÖ\nfunction toLt(id) {\n    const s = String(states[id]?.state || '').toLowerCase();\n    return (s === 'on' || s === 'true') ? 'Aktyvus' : 'I≈°jungtas';\n}\n\nconst lines = [\n    `CO‚ÇÇ lygis: ${getVal(ents.co2, ' ppm')}`,\n    `Darbo re≈æimas: ${states[ents.mode]?.state || 'n/a'}`,\n    `Ventiliatori≈≥ greitis: ${getVal(ents.fan_actual, '%')}`,\n    `Paduodama temperat≈´ra: ${getVal(ents.intake_temp, '¬∞C', 1)}`,\n    `Lauko temperat≈´ra: ${getVal(ents.outdoor, '¬∞C', 1)}`,\n    `Drƒógmƒó vonioje: ${getVal(ents.humidity, '%')}`,\n    `Aktyvus vƒódinimas (Boost): ${toLt(ents.boost_ha)}`,\n    `OVR (i≈°orinis valdymas): ${toLt(ents.ovr_ha)}`\n];\n\nmsg.payload = { chatId: msg.chatId, type: 'message', content: lines.join('\\n') };\nnode.status({ fill: 'green', shape: 'dot', text: 'Statusas v7 paruo≈°tas' });\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 240,
        "wires": [
            [
                "3b5646a6b3bbfec3"
            ]
        ]
    },
    {
        "id": "b84df77aa2da338b",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Reply: /co2",
        "func": "let ha = global.get('homeassistant') || {};\nlet states = (ha?.homeAssistant?.states) || (ha?.homeassistant?.states) || (ha?.states) || {};\nconst raw = states?.['sensor.oro_stotele_carbon_dioxide']?.state;\nconst v = parseFloat(raw);\nmsg.payload = { chatId: msg.chatId, type: 'message', content: isFinite(v) ? `Dabar CO‚ÇÇ: ${Math.round(v)} ppm` : `CO‚ÇÇ nuskaito blogai: ${raw}` };\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 330,
        "y": 300,
        "wires": [
            [
                "3b5646a6b3bbfec3"
            ]
        ]
    },
    {
        "id": "229a694dd09ee7bf",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Reply: /fan",
        "func": "let ha = global.get('homeassistant') || {};\nlet states = (ha?.homeAssistant?.states) || (ha?.homeassistant?.states) || (ha?.states) || {};\nconst a = parseFloat(states?.['sensor.intake_fan_level_current']?.state);\nconst d = parseFloat(states?.['number.intake_level_1']?.state);\nconst aTxt = isFinite(a) ? Math.round(a)+'%' : 'n/a';\nconst dTxt = isFinite(d) ? Math.round(d)+'%' : 'n/a';\nmsg.payload = { chatId: msg.chatId, type: 'message', content: `Fan speed: ${aTxt}` };\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 340,
        "wires": [
            [
                "3b5646a6b3bbfec3"
            ]
        ]
    },
    {
        "id": "4fc293b2c5491c15",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Reply: /mode",
        "func": "let ha = global.get('homeassistant') || {};\nlet states = (ha?.homeAssistant?.states) || (ha?.homeassistant?.states) || (ha?.states) || {};\nconst m = states?.['sensor.komfovent_logic_2']?.state;\nmsg.payload = { chatId: msg.chatId, type: 'message', content: `Re≈æimas: ${m || 'n/a'}` };\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 330,
        "y": 380,
        "wires": [
            [
                "3b5646a6b3bbfec3"
            ]
        ]
    },
    {
        "id": "96f187848d8265a5",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Reply: /boost",
        "func": "let ha = global.get('homeassistant') || {};\nlet states = (ha?.homeAssistant?.states) || (ha?.homeassistant?.states) || (ha?.states) || {};\nconst raw = String(states?.['binary_sensor.komfovent_rate_boost_nr']?.state || '').toLowerCase();\nlet v = null;\nif (raw === 'on' || raw === 'true') v = true;\nelse if (raw === 'off' || raw === 'false') v = false;\nmsg.payload = { chatId: msg.chatId, type: 'message', content: (v===null) ? `Boost b≈´klƒó n/a (${raw})` : (v ? 'Boost: ON' : 'Boost: OFF') };\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 420,
        "wires": [
            [
                "3b5646a6b3bbfec3"
            ]
        ]
    },
    {
        "id": "0f5a16a27ea026ce",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Reply: /humidity",
        "func": "let ha = global.get('homeassistant') || {};\nlet states = (ha?.homeAssistant?.states) || (ha?.homeassistant?.states) || (ha?.states) || {};\nconst v = parseFloat(states?.['sensor.bathroom_humidity']?.state);\nmsg.payload = { chatId: msg.chatId, type: 'message', content: isFinite(v) ? `Vonios drƒógmƒó: ${v.toFixed(1)}%` : 'Vonios drƒógmƒó: n/a' };\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 340,
        "y": 460,
        "wires": [
            [
                "3b5646a6b3bbfec3"
            ]
        ]
    },
    {
        "id": "6bf4d7426e46a7c4",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Reply: /outdoor",
        "func": "let ha = global.get('homeassistant') || {};\nlet states = (ha?.homeAssistant?.states) || (ha?.homeassistant?.states) || (ha?.states) || {};\nconst v = parseFloat(states?.['sensor.boiler_outside_temperature']?.state);\nmsg.payload = { chatId: msg.chatId, type: 'message', content: isFinite(v) ? `Lauko temperat≈´ra: ${v.toFixed(1)}¬∞C` : 'Lauko temperat≈´ra: n/a' };\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 340,
        "y": 500,
        "wires": [
            [
                "3b5646a6b3bbfec3"
            ]
        ]
    },
    {
        "id": "1d2cc3a20712209c",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Build AI context (paths)",
        "func": "// Nustatomi keliai iki vis≈≥ log≈≥ fail≈≥ ir b≈´senos fail≈≥ AI kontekstui.\n// PATAISYMAS: ƒÆtrauktas filters_state.json kelias.\n\nconst TZ = 'Europe/Vilnius';\nconst logBase = '/data/logs/komfovent';\nconst stateBase = '/data/state/komfovent';\n\nfunction ltDate(d) {\n  return new Intl.DateTimeFormat('sv-SE', {\n    timeZone: TZ,\n    year: 'numeric',\n    month: '2-digit',\n    day: '2-digit'\n  }).format(d);\n}\n\nconst day = ltDate(new Date());\n\nmsg._logPaths = {\n  telemetry: `${logBase}/komfovent_telemetry_${day}.jsonl`,\n  control: `${logBase}/komfovent_control_${day}.jsonl`,\n  predictive: `${logBase}/komfovent_predictive_${day}.jsonl`,\n  filters: `${logBase}/komfovent_filters_${day}.jsonl`,\n  matrix: `${stateBase}/prediction_matrix.json`,\n  filters_state: `${stateBase}/filters_state.json`\n};\n\nnode.status({ fill: \"blue\", shape: \"dot\", text: `Paths ready for ${day}` });\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 580,
        "wires": [
            [
                "5c3f116273e2bc12"
            ]
        ]
    },
    {
        "id": "5c3f116273e2bc12",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Tail telemetry cmd",
        "func": "// Agreguoja vis≈≥ moduli≈≥ paskutinius ƒØra≈°us ir b≈´senos failus AI asistentui.\n// PATAISYMAS: ƒÆtrauktas pilnas filtr≈≥ b≈´senos failo nuskaitymas.\n\nconst p = msg._logPaths || {};\n\n// Skaitome b≈´senos failus (visƒÖ turinƒØ) ir log≈≥ failus (paskutines 100 eiluƒçi≈≥).\nmsg.payload = `bash -lc '` +\n    `if [ -f \"${p.matrix}\" ]; then echo \"=== MATRIX ===\"; cat \"${p.matrix}\"; fi; ` +\n    `if [ -f \"${p.filters_state}\" ]; then echo \"=== FILTERS_STATE ===\"; cat \"${p.filters_state}\"; fi; ` +\n    `for f in ${p.telemetry} ${p.control} ${p.predictive} ${p.filters}; do ` +\n    `if [ -f \"$f\" ] && [ \"$f\" != \"undefined\" ]; then echo \"=== $(basename $f) ===\"; tail -n 100 \"$f\"; fi; ` +\n    `done'`;\n\nnode.status({ fill: \"blue\", shape: \"dot\", text: \"Reading logs and state\" });\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 580,
        "wires": [
            [
                "e17bd67575a09940"
            ]
        ]
    },
    {
        "id": "e17bd67575a09940",
        "type": "exec",
        "z": "8e4fe2eda5888688",
        "command": "",
        "addpay": true,
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": false,
        "name": "Exec: tail telemetry (stdout only)",
        "x": 900,
        "y": 580,
        "wires": [
            [
                "10a368fe2c439abf"
            ],
            [],
            []
        ]
    },
    {
        "id": "10a368fe2c439abf",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Capture All Logs",
        "func": "// PATAISYMAS: Log≈≥ duomenys perkeliami ƒØ saug≈≥ kintamƒÖjƒØ.\nlet out = msg.payload;\nif (Buffer.isBuffer(out)) out = out.toString('utf8');\n\nconst logs = String(out || '').trim();\n\n// I≈°saugome logus prompt builder'iui\nmsg._all_logs_context = logs;\n\n// Saugus pass-through sekanƒçiam Exec mazgui\nmsg.payload = \"true\";\n\nif (logs.length > 0) {\n    node.status({ fill: \"green\", shape: \"dot\", text: `Surinkta ${logs.length} simboli≈≥` });\n} else {\n    node.status({ fill: \"yellow\", shape: \"ring\", text: \"Log≈≥ failai tu≈°ti\" });\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1180,
        "y": 580,
        "wires": [
            [
                "1236d6461e4f2730"
            ]
        ]
    },
    {
        "id": "1236d6461e4f2730",
        "type": "exec",
        "z": "8e4fe2eda5888688",
        "command": "",
        "addpay": true,
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": false,
        "name": "Exec: tail control (stdout only)",
        "x": 910,
        "y": 640,
        "wires": [
            [
                "3c0242bc1b5207ae"
            ],
            [],
            []
        ]
    },
    {
        "id": "3c0242bc1b5207ae",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Build prompt (1 message)",
        "func": "// Galutinis prompt builderis su schema v7 duomenimis ir grie≈ætomis taisyklƒómis\nconst rawData = msg._all_logs_context || \"\";\nconst matrix = global.get('prediction_matrix') || {};\nconst ents = global.get('komfovent_entities') || {};\nconst g = global.get('homeassistant') || {};\nconst states = g.states || g.homeAssistant?.states || g.homeassistant?.states || {};\n\n// Pagalbinƒó funkcija rasti reik≈°mes loguose\nfunction findVal(key, text) {\n  const regex = new RegExp(`\"${key}\"\\\\s*:\\\\s*([\\\\d.]+)`, 'g');\n  const matches = Array.from(text.matchAll(regex));\n  return matches.length > 0 ? matches[matches.length - 1][1] : null;\n}\n\n// Saugus b≈´senos gavimas\nconst getS = (id) => {\n  const s = states[id]?.state;\n  return (s === 'unknown' || s === 'unavailable' || !s) ? 'ne≈æinoma' : s;\n};\n\n// Fazƒós: Aktyvus arba I≈°jungtas\nconst ovrStatus = (String(states[ents.ovr_ha]?.state).toLowerCase() === 'on') ? 'Aktyvus' : 'I≈°jungtas';\nconst boostStatus = (String(states[ents.boost_ha]?.state).toLowerCase() === 'on') ? 'Aktyvus' : 'I≈°jungtas';\n\nconst snap = {\n  temp: getS(ents.intake_temp),\n  ovr: ovrStatus,\n  boost: boostStatus,\n  co2: getS(ents.co2),\n  fan: getS(ents.fan_actual),\n  hum: getS(ents.humidity),\n  branda: matrix.training_days_actual || 0\n};\n\nmsg.ai_prompt = `Esi nam≈≥ in≈æinerini≈≥ sistem≈≥ ekspertas. Ra≈°yk tik LIETUVI≈†KAI.\n\nSISTEMOS FAKTAI:\n- Paduodama temperat≈´ra: ${snap.temp} laipsni≈≥.\n- I≈°orinis valdymas (OVR): ${snap.ovr}.\n- Aktyvus vƒódinimas (Boost): ${snap.boost}.\n- CO2 lygis: ${snap.co2} ppm.\n- Ventiliatori≈≥ greitis: ${snap.fan} procent≈≥.\n- Drƒógmƒó vonioje: ${snap.hum} procent≈≥.\n- Matricos branda: ${snap.branda} dienos.\n\nTAISYKLƒñS ATSAKYMUI (GRIE≈ΩTAI):\n1. NENAUDOK JOKI≈≤ ≈ΩVAIG≈ΩDUƒåI≈≤ (*). Atsakyk tik paprastu tekstu be formatavimo.\n2. ATSAKYMƒÑ PRADƒñK NUO FAKTO. Nenaudok \"Atsipra≈°au\", \"Galiu pasakyti\" ar \"Atsi≈ævelgiant ƒØ\".\n3. KALBƒñK KAIP ≈ΩMOGUS. Niekada nenaudok technini≈≥ termin≈≥ su kabutƒómis ar lygybƒós ≈æenklais (pvz., nenaudok \"training_days_actual\":0). Vietoj to sakyk \"duomenys kaupiami ${snap.branda} dien≈≥\".\n4. Jei matai, kad skaiƒçius yra (pvz. ${snap.temp}), niekada nesakyk \"duomen≈≥ neturiu\".\n5. Atsakymas turi b≈´ti trumpas ir draugi≈°kas, iki 3 sakini≈≥.\n\nKLAUSIMAS: ${msg.user_text}`;\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1220,
        "y": 640,
        "wires": [
            [
                "8708465645ec3ae0"
            ]
        ]
    },
    {
        "id": "8708465645ec3ae0",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Prepare Gemini request",
        "func": "const MODEL = 'gemini-2.0-flash';\nconst API_KEY = (typeof env !== 'undefined' && env.get) ? env.get('GEMINI_API_KEY') : null;\nconst key = API_KEY || flow.get('GEMINI_API_KEY');\n\nif (!key) {\n  node.status({ fill: 'red', shape: 'ring', text: 'No GEMINI_API_KEY' });\n  msg.payload = { chatId: msg.chatId, type: 'message', content: 'AI neveikia: nƒóra GEMINI_API_KEY.' };\n  return [msg, null];\n}\n\nmsg.method = 'POST';\nmsg.url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`;\nmsg.headers = { 'Content-Type': 'application/json' };\n\nmsg.payload = {\n  contents: [\n    { role: 'user', parts: [ { text: msg.ai_prompt } ] }\n  ],\n  generationConfig: {\n    temperature: 0.3,\n    maxOutputTokens: 650\n  }\n};\n\nnode.status({ fill: 'blue', shape: 'dot', text: 'AI request...' });\nreturn [null, msg];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1510,
        "y": 640,
        "wires": [
            [
                "3b5646a6b3bbfec3"
            ],
            [
                "0347e80a9d618713"
            ]
        ]
    },
    {
        "id": "0347e80a9d618713",
        "type": "http request",
        "z": "8e4fe2eda5888688",
        "name": "HTTP ‚Üí Gemini",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": true,
        "headers": [],
        "x": 1760,
        "y": 640,
        "wires": [
            [
                "b7f54290520dda9e"
            ]
        ]
    },
    {
        "id": "b7f54290520dda9e",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Parse Gemini ‚Üí Telegram (single msg)",
        "func": "let txt = '';\nlet errTxt = '';\n\nif (msg.statusCode && msg.statusCode >= 400) {\n  const e = msg.payload?.error?.message || JSON.stringify(msg.payload);\n  errTxt = `AI klaida (${msg.statusCode}): ${e}`;\n}\n\nif (!errTxt) {\n  try {\n    const parts = msg.payload?.candidates?.[0]?.content?.parts;\n    if (Array.isArray(parts) && parts.length) {\n      txt = parts.map(p => p.text).filter(Boolean).join('\\n');\n    }\n  } catch (e) {}\n}\n\nif (!txt && errTxt) txt = errTxt;\nif (!txt) txt = 'AI atsakymas tu≈°ƒçias / nepavyko perskaityti.';\n\nconst MAX = 3800;\nif (txt.length > MAX) {\n  txt = txt.slice(0, MAX) + '\\n\\n(‚Ä¶sutruminta, nes per ilga vienai ≈æinutei)';\n}\n\nmsg.payload = { chatId: msg.chatId, type: 'message', content: txt };\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2040,
        "y": 640,
        "wires": [
            [
                "3b5646a6b3bbfec3"
            ]
        ]
    },
    {
        "id": "3b5646a6b3bbfec3",
        "type": "telegram sender",
        "z": "8e4fe2eda5888688",
        "name": "Telegram Out",
        "bot": "tg_bot_cfg_komfovent",
        "outputs": 1,
        "x": 560,
        "y": 260,
        "wires": [
            []
        ]
    },
    {
        "id": "567de76b7fee6e80",
        "type": "link out",
        "z": "8e4fe2eda5888688",
        "name": "AI Out: Control Query",
        "mode": "link",
        "links": [],
        "x": 595,
        "y": 440,
        "wires": []
    },
    {
        "id": "2c73cea35fecb95c",
        "type": "link in",
        "z": "8e4fe2eda5888688",
        "name": "AI In: Control Context",
        "links": [
            "a16e0aa2028bc8af"
        ],
        "x": 655,
        "y": 520,
        "wires": [
            [
                "3a7613b5066d1102"
            ]
        ]
    },
    {
        "id": "3a7613b5066d1102",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Store last Control Context",
        "func": "// 1. I≈°saugom kontekstƒÖ (naudojama AI asistento atminties palaikymui)\nconst ctx = msg.payload;\nflow.set('control_context_last', ctx);\n\n// 2. Identifikuojam prane≈°imƒÖ (ar tai prognozƒó, ar tai auditas)\nconst isShadow = (typeof ctx === 'string' && ctx.includes('Gemini ≈†e≈°ƒólinƒó Analizƒó'));\nconst isAudit = (typeof ctx === 'string' && ctx.includes('AUDITAS')) || msg._is_audit;\n\n// 3. Jei tai viena i≈° DI ataskait≈≥ - siunƒçiam ƒØ Telegram\nif (isShadow || isAudit) {\n    const ALLOWED = Number(env.get(\"MY_TELEGRAM_ID\")) || global.get(\"ALLOWED_TELEGRAM_ID\");\n\n    msg.payload = {\n        chatId: ALLOWED,\n        type: 'message',\n        content: ctx\n    };\n\n    node.status({ fill: 'green', shape: 'dot', text: isAudit ? 'siunƒçiamas auditas' : 'siunƒçiama prognozƒó' });\n    return msg;\n}\n\n// 4. Jei tai paprastas prane≈°imas (debug) - sustojam\nnode.status({ fill: 'gray', shape: 'ring', text: 'ignoruota (ne DI)' });\nreturn null;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 850,
        "y": 500,
        "wires": [
            [
                "3b5646a6b3bbfec3"
            ]
        ]
    },
    {
        "id": "tg_bot_cfg_komfovent",
        "type": "telegram bot",
        "botname": "VentiliationBot",
        "usernames": "",
        "chatids": "",
        "baseapiurl": "",
        "testenvironment": false,
        "updatemode": "polling",
        "addressfamily": "4",
        "pollinterval": "2",
        "usesocks": false,
        "sockshost": "",
        "socksport": "6667",
        "socksusername": "anonymous",
        "sockspassword": "",
        "bothost": "",
        "botpath": "",
        "localbothost": "",
        "localbotport": "8443",
        "publicbotport": "8443",
        "privatekey": "",
        "certificate": "",
        "useselfsignedcertificate": false,
        "sslterminated": false,
        "verboselogging": false
    },
    {
        "id": "7b760500aab08108",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-telegrambot": "17.0.5"
        }
    }
]
