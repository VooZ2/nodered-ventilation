[
    {
        "id": "6ff955ee3e10e431",
        "type": "tab",
        "label": "Komfovent: Module - AI Gateway",
        "disabled": false,
        "info": ""
    },
    {
        "id": "675143a7fa1719d7",
        "type": "telegram receiver",
        "z": "6ff955ee3e10e431",
        "name": "Telegram In",
        "bot": "tg_bot_cfg_komfovent",
        "saveDataDir": "",
        "filterCommands": false,
        "hasinput": false,
        "inputs": 0,
        "handleallupdates": false,
        "x": 110,
        "y": 40,
        "wires": [
            [
                "ebfe5f4f96f066d4"
            ],
            []
        ]
    },
    {
        "id": "ebfe5f4f96f066d4",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "ID Filter & Text Prep",
        "func": "const ALLOWED = Number(env.get(\"MY_TELEGRAM_ID\")) || global.get(\"ALLOWED_TELEGRAM_ID\");\nconst chatId = msg.payload?.chatId;\n\nif (chatId !== ALLOWED) {\n  node.status({ fill: \"red\", shape: \"ring\", text: \"Blokuota: \" + chatId });\n  return null;\n}\n\nmsg.user_text = String(msg.payload?.content || \"\").trim();\nmsg.chatId = chatId;\n\nnode.status({ fill: \"green\", shape: \"dot\", text: \"Vartotojas OK\" });\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 40,
        "wires": [
            [
                "abcfa11de1d5444a"
            ]
        ]
    },
    {
        "id": "abcfa11de1d5444a",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Classify (slash only)",
        "func": "const t = (msg.user_text || '').trim();\nconst tl = t.toLowerCase();\n\n// Visi quick statusai tik su / (kad 'co2' netaptÅ³ statusu)\nlet intent = 'ai';\n\nif (tl === '/start' || tl === '/help' || tl === '/h') intent = 'help';\nelse if (tl === '/status') intent = 'status';\nelse if (tl === '/co2') intent = 'co2';\nelse if (tl === '/fan') intent = 'fan';\nelse if (tl === '/mode') intent = 'mode';\nelse if (tl === '/boost') intent = 'boost';\nelse if (tl === '/humidity') intent = 'humidity';\nelse if (tl === '/outdoor') intent = 'outdoor';\nelse if (tl === '/matrix') intent = 'matrix';  \nelse if (tl === '/shadow') intent = 'shadow';  \n\nmsg.intent = intent;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 40,
        "wires": [
            [
                "f7b2bdd1b471fa7d"
            ]
        ]
    },
    {
        "id": "f7b2bdd1b471fa7d",
        "type": "switch",
        "z": "6ff955ee3e10e431",
        "name": "Route intent",
        "property": "intent",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "help",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "status",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "co2",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "fan",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "mode",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "boost",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "humidity",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "outdoor",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "matrix",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "shadow",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 11,
        "x": 110,
        "y": 180,
        "wires": [
            [
                "d869027d9431efc4"
            ],
            [
                "ebcf04a7c62df620"
            ],
            [
                "f739d6707013982c"
            ],
            [
                "056c66f67642fd8f"
            ],
            [
                "bec1627ba76b405e"
            ],
            [
                "5a5aa54bf7a78547"
            ],
            [
                "3816232c6a7c071d"
            ],
            [
                "6c040c32e46a9512"
            ],
            [
                "4b57e38bbb17924e"
            ],
            [
                "5cb6165420781567"
            ],
            [
                "96fb7365808dcd7c",
                "63ae068f91114f13"
            ]
        ]
    },
    {
        "id": "d869027d9431efc4",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: Help",
        "func": "msg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: [\n        'ğŸŒ¬ï¸ Komfovent valdymas',\n        '',\n        'ğŸ“ PagrindinÄ—s komandos:',\n        '/status - Pilna parametrÅ³ suvestinÄ—',\n        '/co2 - â˜ï¸ Anglies dvideginio lygis',\n        '/fan - ğŸ“Š VentiliatoriÅ³ greitis',\n        '/mode - âš™ï¸ Veikimo reÅ¾imas',\n        '/boost - ğŸš€ Aktyvus vÄ—dinimas',\n        '/humidity - ğŸ’§ DrÄ—gmÄ— vonioje',\n        '/outdoor - â˜€ï¸ Lauko temperatÅ«ra',\n        '',\n        'ğŸ“Š PrognozÄ—s:',\n        '/shadow - ğŸ§  Rizikos vertinimas ir prognozÄ—',\n        '/matrix - ğŸ“Š Modelio branda ir duomenÅ³ kiekis',\n        '',\n        'ğŸ§  Gemini AI asistentas:',\n        'â€¢ \"atlik vakar dienos auditÄ…\" â€“ iÅ¡sami paros apÅ¾valga',\n        'â€¢ \"kodÄ—l dabar fan 35%?\" â€“ logÅ³ interpretacija',\n        'â€¢ \"kiek liko filtrÅ³ resursÅ³?\" â€“ filtrÅ³ bÅ«senos analizÄ—',\n        'â€¢ \"palygink CO2 su vakar diena\" â€“ istorinis palyginimas',\n        '',\n        'ğŸ’¡ Atsakymus pateikia Gemini AI.'\n    ].join('\\n')\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 290,
        "y": 100,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "ebcf04a7c62df620",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: /status",
        "func": "const g = global.get('homeassistant') || {};\n\nconst states =\n  (g?.homeAssistant?.states) ||\n  (g?.homeassistant?.states) ||\n  (g?.states) ||\n  {};\n\nconst ents = global.get('komfovent_entities') || {};\n\nfunction isBad(v) {\n  if (v === null || v === undefined) return true;\n  const s = String(v).trim().toLowerCase();\n  return (s === '' || s === 'unknown' || s === 'unavailable' || s === 'nan');\n}\n\nfunction getVal(id, unit = '', dec = 0) {\n  const raw = states[id]?.state;\n  if (isBad(raw)) return 'n/a';\n  const v = parseFloat(raw);\n  return isFinite(v) ? v.toFixed(dec) + unit : 'n/a';\n}\n\nfunction toLt(id) {\n  const raw = states[id]?.state;\n  if (isBad(raw)) return 'n/a';\n  const s = String(raw).toLowerCase();\n  return (s === 'on' || s === 'true') ? 'Aktyvus' : 'IÅ¡jungtas';\n}\n\n/* ===============================\n   Gartraukio bÅ«sena\n   - Light-only ignoruojama\n   - ON >= 75W\n   =============================== */\n\nlet hoodLine = 'ğŸ§¯ Gartraukis: IÅ¡jungta';\n\nconst hoodRaw = states['sensor.hood_socket_power']?.state;\nif (!isBad(hoodRaw)) {\n  const hoodP = parseFloat(hoodRaw);\n  if (isFinite(hoodP) && hoodP >= 75) {\n    const lvl = (hoodP >= 145) ? 3 : (hoodP >= 105) ? 2 : 1;\n    hoodLine = `ğŸ§¯ Gartraukis: Ä®jungta (${lvl} lygis)`;\n  }\n}\n\nconst lines = [\n  `â˜ï¸ COâ‚‚ lygis: ${getVal(ents.co2, ' ppm')}`,\n  `âš™ï¸ Darbo reÅ¾imas: ${states[ents.mode]?.state || 'n/a'}`,\n  `ğŸ“Š VentiliatoriÅ³ greitis: ${getVal(ents.fan_actual, '%')}`,\n  `ğŸŒ¡ï¸ Paduodama temperatÅ«ra: ${getVal(ents.intake_temp, 'Â°C', 1)}`,\n  `â„ï¸ Lauko temperatÅ«ra: ${getVal(ents.outdoor, 'Â°C', 1)}`,\n  `ğŸ’§ DrÄ—gmÄ— vonioje: ${getVal(ents.humidity, '%')}`,\n  `ğŸš€ Aktyvus vÄ—dinimas: ${toLt(ents.boost_ha)}`,\n  hoodLine,\n  `ğŸ”Œ OVR: ${toLt(ents.ovr_ha)}`\n];\n\nmsg.payload = {\n  chatId: msg.chatId,\n  type: 'message',\n  content: lines.join('\\n')\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 140,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "f739d6707013982c",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: /co2",
        "func": "const g = global.get('homeassistant') || {};\nconst states =\n  (g.homeAssistant && g.homeAssistant.states) ? g.homeAssistant.states :\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\nconst ents = global.get('komfovent_entities') || {};\n\nconst raw = states[ents.co2]?.state;\nconst v = parseFloat(raw);\nconst content = isFinite(v) ? `â˜ï¸ COâ‚‚ lygis: ${Math.round(v)} ppm` : `âš ï¸ COâ‚‚ duomenÅ³ nÄ—ra: ${raw}`;\n\nmsg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: content\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 290,
        "y": 180,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "056c66f67642fd8f",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: /fan",
        "func": "const g = global.get('homeassistant') || {};\nconst states =\n  (g.homeAssistant && g.homeAssistant.states) ? g.homeAssistant.states :\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\nconst ents = global.get('komfovent_entities') || {};\n\nconst actual = parseFloat(states[ents.fan_actual]?.state);\nconst content = isFinite(actual)\n    ? `ğŸ“Š VentiliatoriÅ³ greitis: ${Math.round(actual)}%`\n    : `âš ï¸ VentiliatoriÅ³ duomenÅ³ nÄ—ra`;\n\nmsg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: content\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 290,
        "y": 220,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "bec1627ba76b405e",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: /mode",
        "func": "const g = global.get('homeassistant') || {};\nconst states =\n  (g.homeAssistant && g.homeAssistant.states) ? g.homeAssistant.states :\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\nconst ents = global.get('komfovent_entities') || {};\n\nconst m = states[ents.mode]?.state;\nconst content = m ? `âš™ï¸ Darbo reÅ¾imas: ${m}` : `âš ï¸ ReÅ¾imas nenustatytas`;\n\nmsg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: content\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 260,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "5a5aa54bf7a78547",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: /boost",
        "func": "const g = global.get('homeassistant') || {};\nconst states =\n  (g.homeAssistant && g.homeAssistant.states) ? g.homeAssistant.states :\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\nconst ents = global.get('komfovent_entities') || {};\n\nfunction toLt(id) {\n    const s = String(states[id]?.state || '').toLowerCase();\n    return (s === 'on' || s === 'true') ? 'Aktyvus' : 'IÅ¡jungtas';\n}\n\nconst content = `ğŸš€ Aktyvus vÄ—dinimas (Boost): ${toLt(ents.boost_ha)}`;\n\nmsg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: content\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 300,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "3816232c6a7c071d",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: /humidity",
        "func": "const g = global.get('homeassistant') || {};\nconst states =\n  (g.homeAssistant && g.homeAssistant.states) ? g.homeAssistant.states :\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\nconst ents = global.get('komfovent_entities') || {};\n\nconst v = parseFloat(states[ents.humidity]?.state);\nconst content = isFinite(v)\n    ? `ğŸ’§ DrÄ—gmÄ— vonioje: ${v.toFixed(1)}%`\n    : `âš ï¸ DrÄ—gmÄ—s duomenÅ³ nÄ—ra`;\n\nmsg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: content\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 340,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "6c040c32e46a9512",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: /outdoor",
        "func": "const g = global.get('homeassistant') || {};\nconst states =\n  (g.homeAssistant && g.homeAssistant.states) ? g.homeAssistant.states :\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\nconst ents = global.get('komfovent_entities') || {};\n\nconst v = parseFloat(states[ents.outdoor]?.state);\nlet content = \"\";\n\nif (isFinite(v)) {\n    // 1. Parenkame ikonÄ… pagal temperatÅ«rÄ…\n    let icon = (v >= 10) ? \"â˜€ï¸\" : \"â„ï¸\";\n    content = `${icon} Lauko temperatÅ«ra: ${v.toFixed(1)}Â°C\\n`;\n\n    // 2. Pridedame Å¡eimos rekomendacijas\n    if (v <= -10) {\n        content += \"\\nğŸ§¤ Vaikams reikia Å¾ieminiÅ³ drabuÅ¾iÅ³!\";\n    }\n\n    if (v <= 0) {\n        content += \"\\nğŸš— Laikas paÅ¡ildyti automobilÄ¯.\";\n    } else if (v > 0 && v < 10) {\n        content += \"\\nğŸ§¥ Lauke vÄ—su, nepamirÅ¡kite striukiÅ³.\";\n    } else if (v >= 20) {\n        content += \"\\nğŸ˜ Puikus oras pasivaikÅ¡Äiojimui!\";\n    }\n} else {\n    content = \"âš ï¸ Lauko temperatÅ«ros duomenÅ³ nÄ—ra\";\n}\n\nmsg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: content\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 380,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "96fb7365808dcd7c",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Build AI context (paths)",
        "func": "// Nustatomi keliai iki visÅ³ logÅ³ failÅ³ ir bÅ«senos failÅ³ AI kontekstui.\n// PATAISYMAS: Ä®trauktas filters_state.json kelias.\n\nconst TZ = 'Europe/Vilnius';\nconst logBase = '/data/logs/komfovent';\nconst stateBase = '/data/state/komfovent';\n\nfunction ltDate(d) {\n  return new Intl.DateTimeFormat('sv-SE', {\n    timeZone: TZ,\n    year: 'numeric',\n    month: '2-digit',\n    day: '2-digit'\n  }).format(d);\n}\n\nconst day = ltDate(new Date());\n\nmsg._logPaths = {\n  telemetry: `${logBase}/komfovent_telemetry_${day}.jsonl`,\n  control: `${logBase}/komfovent_control_${day}.jsonl`,\n  predictive: `${logBase}/komfovent_predictive_${day}.jsonl`,\n  filters: `${logBase}/komfovent_filters_${day}.jsonl`,\n  matrix: `${stateBase}/prediction_matrix.json`,\n  filters_state: `${stateBase}/filters_state.json`\n};\n\nnode.status({ fill: \"blue\", shape: \"dot\", text: `Paths ready for ${day}` });\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 500,
        "wires": [
            [
                "eb5198f89b492515"
            ]
        ]
    },
    {
        "id": "eb5198f89b492515",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Tail telemetry cmd",
        "func": "const p = msg._logPaths || {};\n\n// Skaitome bÅ«senos failus ir ribotÄ… logÅ³ istorijÄ… (balansas tarp konteksto ir stabilumo).\n// - Telemetry: 50 eiluÄiÅ³ (tendencijoms)\n// - Control: 30 eiluÄiÅ³ (paskutiniai sprendimai / OVR / HOOD / boost)\n// - Predictive: 20 eiluÄiÅ³\n// - Filters: 10 eiluÄiÅ³\n\nmsg.payload = `bash -lc '` +\n  `if [ -f \"${p.matrix}\" ]; then echo \"=== MATRIX ===\"; cat \"${p.matrix}\"; fi; ` +\n  `if [ -f \"${p.filters_state}\" ]; then echo \"=== FILTERS_STATE ===\"; cat \"${p.filters_state}\"; fi; ` +\n  `if [ -f \"${p.telemetry}\" ] && [ \"${p.telemetry}\" != \"undefined\" ]; then echo \"=== $(basename ${p.telemetry}) ===\"; tail -n 50 \"${p.telemetry}\"; fi; ` +\n  `if [ -f \"${p.control}\" ] && [ \"${p.control}\" != \"undefined\" ]; then echo \"=== $(basename ${p.control}) ===\"; tail -n 30 \"${p.control}\"; fi; ` +\n  `if [ -f \"${p.predictive}\" ] && [ \"${p.predictive}\" != \"undefined\" ]; then echo \"=== $(basename ${p.predictive}) ===\"; tail -n 20 \"${p.predictive}\"; fi; ` +\n  `if [ -f \"${p.filters}\" ] && [ \"${p.filters}\" != \"undefined\" ]; then echo \"=== $(basename ${p.filters}) ===\"; tail -n 10 \"${p.filters}\"; fi; ` +\n  `'`;\n\nnode.status({ fill: \"blue\", shape: \"dot\", text: \"Reading logs: T50 C30 P20 F10\" });\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 570,
        "y": 500,
        "wires": [
            [
                "cde32ceab90e3ab7"
            ]
        ]
    },
    {
        "id": "cde32ceab90e3ab7",
        "type": "exec",
        "z": "6ff955ee3e10e431",
        "command": "",
        "addpay": true,
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": false,
        "name": "Exec: tail telemetry (stdout only)",
        "x": 830,
        "y": 500,
        "wires": [
            [
                "47276443c90c79c0"
            ],
            [],
            []
        ]
    },
    {
        "id": "47276443c90c79c0",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Capture All Logs",
        "func": "// PATAISYMAS: LogÅ³ duomenys perkeliami Ä¯ saugÅ³ kintamÄ…jÄ¯.\nlet out = msg.payload;\nif (Buffer.isBuffer(out)) out = out.toString('utf8');\n\nconst logs = String(out || '').trim();\n\n// IÅ¡saugome logus prompt builder'iui\nmsg._all_logs_context = logs;\n\n// Toliau nebevykdom papildomo Exec, todÄ—l msg.payload nekeiÄiam.\n\nif (logs.length > 0) {\n    node.status({ fill: \"green\", shape: \"dot\", text: `Surinkta ${logs.length} simboliÅ³` });\n} else {\n    node.status({ fill: \"yellow\", shape: \"ring\", text: \"LogÅ³ failai tuÅ¡ti\" });\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 290,
        "y": 580,
        "wires": [
            [
                "cdf0a918f5808d27"
            ]
        ]
    },
    {
        "id": "5d49fc4b1470e1ec",
        "type": "telegram sender",
        "z": "6ff955ee3e10e431",
        "name": "Telegram Out",
        "bot": "tg_bot_cfg_komfovent",
        "outputs": 1,
        "x": 540,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "63ae068f91114f13",
        "type": "link out",
        "z": "6ff955ee3e10e431",
        "name": "AI Out: Control Query",
        "mode": "link",
        "links": [
            "1ed0cbe82dd78d30",
            "2ce33c61ffe1a0b7"
        ],
        "x": 65,
        "y": 340,
        "wires": []
    },
    {
        "id": "5e34d037680f59dc",
        "type": "link in",
        "z": "6ff955ee3e10e431",
        "name": "AI In: Control Context",
        "links": [
            "a1ae1f426339e402",
            "b92350a17d9b1a04"
        ],
        "x": 515,
        "y": 220,
        "wires": [
            [
                "ea555fdc1f28ec24"
            ]
        ]
    },
    {
        "id": "ea555fdc1f28ec24",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Store last Control Context",
        "func": "// Store last Control Context v4.4.1 (Bugfix)\n// Tikslas: teisingai paimti kontekstÄ… iÅ¡ Link In Å¾inutÄ—s.\n// Problema: Control flow siunÄia msg.ai_context, bet senas kodas Å¾iÅ«rÄ—jo tik Ä¯ msg.payload.\n\nlet ctx = null;\n\n// 1) Pirmas prioritetas: msg.ai_context (taip siunÄia Control tab)\nif (msg && typeof msg === 'object' && msg.ai_context && typeof msg.ai_context === 'object') {\n    ctx = msg.ai_context;\n}\n\n// 2) Fallback: msg.payload.ai_context (jei kaÅ¾kur supakuota Ä¯ payload)\nif (!ctx && msg && typeof msg === 'object' && msg.payload && typeof msg.payload === 'object' && msg.payload.ai_context) {\n    ctx = msg.payload.ai_context;\n}\n\n// 3) Fallback: jei payload pats yra kontekstas\nif (!ctx && msg && typeof msg === 'object' && msg.payload && typeof msg.payload === 'object') {\n    // Heuristika: jei panaÅ¡u Ä¯ kontekstÄ… (turi bent vienÄ… tipinÄ¯ laukÄ…)\n    const p = msg.payload;\n    if (p.co2 !== undefined || p.rate_current !== undefined || p.fans !== undefined || p.rules !== undefined) {\n        ctx = p;\n    }\n}\n\n// 4) Fallback: jei payload yra JSON string\nif (!ctx && msg && typeof msg === 'object' && typeof msg.payload === 'string') {\n    try {\n        const parsed = JSON.parse(msg.payload);\n        if (parsed && typeof parsed === 'object') {\n            if (parsed.ai_context && typeof parsed.ai_context === 'object') ctx = parsed.ai_context;\n            else if (parsed.co2 !== undefined || parsed.rate_current !== undefined || parsed.fans !== undefined || parsed.rules !== undefined) ctx = parsed;\n        }\n    } catch (e) {\n        // ignore\n    }\n}\n\n// Jei vis tiek nÄ—ra â€“ tiesiog nieko nedarom (kad nesugriautume srauto)\nif (!ctx || typeof ctx !== 'object') {\n    return null;\n}\n\n// Minimalus normalizavimas, kad Prompt Builder turÄ—tÅ³ stabilias Å¡aknis\nctx.fans = (ctx.fans && typeof ctx.fans === 'object') ? ctx.fans : {};\nctx.rules = (ctx.rules && typeof ctx.rules === 'object') ? ctx.rules : {};\n\n// Ä®raÅ¡om Ä¯ flow kaip source-of-truth AI Gateway pusÄ—je\nflow.set('control_context_last', ctx);\nflow.set('control_context_last_ts', Date.now());\n\n// Å is mazgas neturi tÄ™sti srauto (tik â€œcacheâ€)\nreturn null;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 220,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "4b57e38bbb17924e",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: /matrix",
        "func": "const m = global.get('prediction_matrix') || {};\nif (!m.data) {\n    msg.payload = { chatId: msg.chatId, type: 'message', content: 'âŒ Matrica dar nesugeneruota. Laukite naktinio mokymosi (03:05).' };\n    return msg;\n}\nconst ci = m.confidence_info || {};\nconst lines = [\n    `ğŸ“Š Modelio versija: v${m.model_ver || '6.1'}`,\n    `ğŸ“… Mokymosi laikas: ${m.training_days_actual || 0} d.`,\n    `ğŸ“ˆ Tikslumas: ${(ci.level || 'n/a').toUpperCase()}`,\n    `ğŸš€ ReÅ¾imas: ${ci.is_live_ready ? 'Aktyvus' : 'Shadow mode'}`,\n    `ğŸ•’ Generuota: ${m.generated_at ? new Date(m.generated_at).toLocaleString('lt-LT') : 'n/a'}`\n];\nmsg.payload = { chatId: msg.chatId, type: 'message', content: lines.join('\\n') };\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 420,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "5cb6165420781567",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: /shadow",
        "func": "const u = flow.get('predictive_last') || {};\n\nif (!u.ts) {\n    msg.payload = {\n        chatId: msg.chatId,\n        type: 'message',\n        content: 'âš ï¸ Predictive Ä¯raÅ¡Å³ dar nÄ—ra.'\n    };\n    return msg;\n}\n\nconst lines = [\n    `ğŸ§  PrognozÄ—s rizika: ${u.risk_score || 0}/10`,\n    `ğŸ’¨ COâ‚‚ pokytis: ${u.co2} â†’ ${u.co2_f_30} ppm (+30m)`,\n    `ğŸ¯ Z-Score (COâ‚‚/Rate): ${(u.z_co2 || 0).toFixed(2)} / ${(u.z_rate || 0).toFixed(2)}`,\n    `ğŸ“œ Statusas: ${String(u.anomaly_status || 'normal').toUpperCase()}`,\n    `ğŸ› ï¸ Rizikos korekcija: +${u.risk_adjust || 0}`\n];\n\nmsg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: lines.join('\\n')\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 460,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "cdf0a918f5808d27",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Build prompt (1 message)",
        "func": "// Prompt Builder (Token Optimized) v7.11.2 (Bugfix + Style)\n// Tikslas: vientisas LT tekstas (3â€“5 sakiniai), be pasisveikinimÅ³, kreipinys \"Tu\".\n// Bugfix: jei msg.ai_context tuÅ¡Äias, imam flow.control_context_last.\n\nconst ctx = (msg.ai_context && typeof msg.ai_context === 'object')\n  ? msg.ai_context\n  : (flow.get('control_context_last') || {});\n\nconst rawLogs = String(msg._all_logs_context || \"\");\nconst userText = String(msg.user_text || \"\").trim();\nconst qLower = userText.toLowerCase();\n\n// --- 1) Gating (tokenÅ³ taupymas) ---\nconst isPast = /(kada|paskutin|buvo|istorij|log|vyko|Ä¯vyko|prieÅ¡|vakar|anksÄiau)/i.test(qLower);\nconst isHypo = /(kas bÅ«tÅ³|scenarij|kÄ… darytÅ³|elgtÅ³si|jeigu|jei)/i.test(qLower);\n\n// --- 2) PagalbinÄ—s funkcijos ---\nconst fans = (ctx.fans && typeof ctx.fans === 'object') ? ctx.fans : {};\nconst rules = (ctx.rules && typeof ctx.rules === 'object') ? ctx.rules : {};\n\nconst toNum = (v) => {\n  const n = Number(v);\n  return Number.isFinite(n) ? n : null;\n};\n\nconst hasNum = (v) => toNum(v) !== null;\n\nconst fmtInt = (v) => {\n  const n = toNum(v);\n  return (n === null) ? null : String(Math.round(n));\n};\n\nconst fmtRate = (v) => {\n  const n = toNum(v);\n  return (n === null) ? null : String(Number(n.toFixed(2)));\n};\n\n// --- 3) FaktÅ³ sakiniai (be \"n/a\") ---\nconst sents = [];\n\n// CO2 + rate\nconst co2 = fmtInt(ctx.co2);\nconst rate = fmtRate(ctx.rate_current);\nif (co2 && rate) sents.push(`Dabar COâ‚‚ yra ${co2} ppm, o kilimo greitis ${rate} ppm/min`);\nelse if (co2) sents.push(`Dabar COâ‚‚ yra ${co2} ppm`);\n\n// Fan IN/OUT + pressure\nconst fin = fmtInt(fans.fan_in);\nconst fout = fmtInt(fans.fan_out);\nif (fin && fout) {\n  let pText = '';\n  if (fans.pressure_state === 'positive_pressure') pText = 'â€” palaikomas teigiamas slÄ—gis (tiekimas didesnis)';\n  else if (fans.pressure_state === 'negative_pressure') pText = 'â€” palaikomas neigiamas slÄ—gis (iÅ¡traukimas didesnis)';\n  else pText = 'â€” oro srautai subalansuoti';\n  sents.push(`VÄ—dinimas dirba ${fin}% (tiekimas) ir ${fout}% (iÅ¡traukimas) ${pText}`);\n}\n\n// Hood / boost / outdoor (tik jei turim)\nconst misc = [];\n\nif (fans.hood === true) misc.push(`gartraukis veikia ${fans.hood_level || 1} lygiu`);\nelse if (fans.hood === false) misc.push(`gartraukis iÅ¡jungtas`);\n\nconst outdoor = fmtInt(ctx.outdoor);\nif (outdoor) misc.push(`lauke ${outdoor}Â°C`);\n\nif (ctx.boost_active === true) misc.push(`boost aktyvus`);\nelse if (ctx.boost_active === false) misc.push(`boost neaktyvus`);\n\nif (misc.length) sents.push(misc.join(', '));\n\n// UÅ¾tikrinam 3â€“5 sakinius: jei per maÅ¾ai, pridedam trumpÄ… â€œmodeâ€ sakinÄ¯ (jei yra)\nconst mode = (ctx.mode && String(ctx.mode).trim()) ? String(ctx.mode).trim() : null;\nif (sents.length < 3 && mode) sents.push(`ReÅ¾imas: ${mode}`);\n\n// --- 4) HipotetinÄ— logika (tik kai reikia) ---\n// Svarbu: tai instrukcija modeliui, ne â€œcituojamos taisyklÄ—sâ€\nlet logicBlock = \"\";\nif (isHypo) {\n  const thr = toNum(rules.rate_threshold_ppm_min);\n  const minCo2 = toNum(rules.min_co2_for_boost_ppm);\n  const prio = Array.isArray(rules.priority_order) ? rules.priority_order.join(' > ') : null;\n\n  const parts = [];\n  if (thr !== null) parts.push(`Boost scenarijus: Ä¯sijungia kai COâ‚‚ kilimo greitis >= ${thr} ppm/min`);\n  if (minCo2 !== null) parts.push(`ir kai COâ‚‚ >= ${Math.round(minCo2)} ppm`);\n  if (prio) parts.push(`Prioritetai: ${prio}`);\n\n  if (parts.length) logicBlock = parts.join('. ') + '.';\n}\n\n// --- 5) Logai (tik jei klausiama apie praeitÄ¯) ---\nlet logsBlock = \"\";\nif (isPast && rawLogs) {\n  // labai paprastas apkarpymas â€“ laikom trumpÄ…\n  logsBlock = rawLogs.slice(-2500);\n}\n\n// --- 6) Galutinis prompt ---\nconst factsText = sents.filter(Boolean).join('. ').trim() + (sents.length ? '.' : '');\n\nmsg.ai_prompt = `\nEsi Komfovent namÅ³ asistentas-inÅ¾inierius. RaÅ¡yk tik LIETUVIÅ KAI.\nKreipkis â€Tuâ€œ. Be pasisveikinimÅ³ ir be â€atsipraÅ¡auâ€œ. Be sÄ…raÅ¡Å³, brÅ«kÅ¡neliÅ³, Å¾vaigÅ¾duÄiÅ³ (*) ir emoji.\nAtsakyk 3â€“5 sakiniais, vienu vientisu paragrafu. Atsakyk tik Ä¯ klausimÄ….\n\n${factsText}\n${logicBlock ? logicBlock : \"\"}\n\n${(isPast && logsBlock) ? `Jei klausiama apie praeitÄ¯, remkis Å¡iuo logÅ³ fragmentu:\\n${logsBlock}` : \"\"}\n\nKLAUSIMAS: ${userText}\n`.trim();\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 580,
        "wires": [
            [
                "433da280ca0fe8f5"
            ]
        ]
    },
    {
        "id": "433da280ca0fe8f5",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Prepare Gemini request",
        "func": "const MODEL = 'gemini-2.0-flash';\nconst API_KEY = (typeof env !== 'undefined' && env.get) ? env.get('GEMINI_API_KEY') : null;\nconst key = API_KEY || flow.get('GEMINI_API_KEY');\n\nif (!key) {\n  node.status({ fill: 'red', shape: 'ring', text: 'No GEMINI_API_KEY' });\n  msg.payload = { chatId: msg.chatId, type: 'message', content: 'AI neveikia: nÄ—ra GEMINI_API_KEY.' };\n  return [msg, null];\n}\n\nmsg.method = 'POST';\nmsg.url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`;\nmsg.headers = { 'Content-Type': 'application/json' };\n\nmsg.payload = {\n  contents: [\n    { role: 'user', parts: [ { text: msg.ai_prompt } ] }\n  ],\n  generationConfig: {\n    temperature: 0.3,\n    maxOutputTokens: 650\n  }\n};\n\nnode.status({ fill: 'blue', shape: 'dot', text: 'AI request...' });\nreturn [null, msg];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 580,
        "wires": [
            [],
            [
                "5944086c10a6f826"
            ]
        ]
    },
    {
        "id": "5944086c10a6f826",
        "type": "http request",
        "z": "6ff955ee3e10e431",
        "name": "HTTP â†’ Gemini",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": true,
        "headers": [],
        "x": 1020,
        "y": 580,
        "wires": [
            [
                "de086cbcb3ed9711"
            ]
        ]
    },
    {
        "id": "de086cbcb3ed9711",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Parse Gemini â†’ Telegram (single msg)",
        "func": "let txt = '';\nlet errTxt = '';\n\nif (msg.statusCode && msg.statusCode >= 400) {\n  const e = msg.payload?.error?.message || JSON.stringify(msg.payload);\n  errTxt = `AI klaida (${msg.statusCode}): ${e}`;\n}\n\nif (!errTxt) {\n  try {\n    const parts = msg.payload?.candidates?.[0]?.content?.parts;\n    if (Array.isArray(parts) && parts.length) {\n      txt = parts.map(p => p.text).filter(Boolean).join('\\n');\n    }\n  } catch (e) {}\n}\n\nif (!txt && errTxt) txt = errTxt;\nif (!txt) txt = 'AI atsakymas tuÅ¡Äias / nepavyko perskaityti.';\n\nconst MAX = 3800;\nif (txt.length > MAX) {\n  txt = txt.slice(0, MAX) + '\\n\\n(â€¦sutruminta, nes per ilga vienai Å¾inutei)';\n}\n\nmsg.payload = { chatId: msg.chatId, type: 'message', content: txt };\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1190,
        "y": 480,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "tg_bot_cfg_komfovent",
        "type": "telegram bot",
        "botname": "VentiliationBot",
        "usernames": "",
        "chatids": "",
        "baseapiurl": "",
        "testenvironment": false,
        "updatemode": "polling",
        "addressfamily": "4",
        "pollinterval": "2",
        "usesocks": false,
        "sockshost": "",
        "socksport": "6667",
        "socksusername": "anonymous",
        "sockspassword": "",
        "bothost": "",
        "botpath": "",
        "localbothost": "",
        "localbotport": "8443",
        "publicbotport": "8443",
        "privatekey": "",
        "certificate": "",
        "useselfsignedcertificate": false,
        "sslterminated": false,
        "verboselogging": false
    },
    {
        "id": "8a3a5e6424ada3b9",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-telegrambot": "17.0.5"
        }
    }
]