[
    {
        "id": "6ff955ee3e10e431",
        "type": "tab",
        "label": "Komfovent: Module - AI Gateway",
        "disabled": false,
        "info": ""
    },
    {
        "id": "675143a7fa1719d7",
        "type": "telegram receiver",
        "z": "6ff955ee3e10e431",
        "name": "Telegram In",
        "bot": "tg_bot_cfg_komfovent",
        "saveDataDir": "",
        "filterCommands": false,
        "hasinput": false,
        "inputs": 0,
        "handleallupdates": false,
        "x": 110,
        "y": 40,
        "wires": [
            [
                "ebfe5f4f96f066d4"
            ],
            []
        ]
    },
    {
        "id": "ebfe5f4f96f066d4",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "ID Filter & Text Prep",
        "func": "const ALLOWED = Number(env.get(\"MY_TELEGRAM_ID\")) || global.get(\"ALLOWED_TELEGRAM_ID\");\nconst chatId = msg.payload?.chatId;\n\nif (chatId !== ALLOWED) {\n  node.status({ fill: \"red\", shape: \"ring\", text: \"Blokuota: \" + chatId });\n  return null;\n}\n\nmsg.user_text = String(msg.payload?.content || \"\").trim();\nmsg.chatId = chatId;\n\nnode.status({ fill: \"green\", shape: \"dot\", text: \"Vartotojas OK\" });\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 40,
        "wires": [
            [
                "abcfa11de1d5444a"
            ]
        ]
    },
    {
        "id": "abcfa11de1d5444a",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Classify (slash only)",
        "func": "const t = (msg.user_text || '').trim();\nconst tl = t.toLowerCase();\n\n// Visi quick statusai tik su / (kad 'co2' netaptÅ³ statusu)\nlet intent = 'ai';\n\nif (tl === '/start' || tl === '/help' || tl === '/h') intent = 'help';\nelse if (tl === '/status') intent = 'status';\nelse if (tl === '/co2') intent = 'co2';\nelse if (tl === '/fan') intent = 'fan';\nelse if (tl === '/mode') intent = 'mode';\nelse if (tl === '/boost') intent = 'boost';\nelse if (tl === '/humidity') intent = 'humidity';\nelse if (tl === '/outdoor') intent = 'outdoor';\nelse if (tl === '/matrix') intent = 'matrix';  \nelse if (tl === '/shadow') intent = 'shadow';  \n\nmsg.intent = intent;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 40,
        "wires": [
            [
                "f7b2bdd1b471fa7d"
            ]
        ]
    },
    {
        "id": "f7b2bdd1b471fa7d",
        "type": "switch",
        "z": "6ff955ee3e10e431",
        "name": "Route intent",
        "property": "intent",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "help",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "status",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "co2",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "fan",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "mode",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "boost",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "humidity",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "outdoor",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "matrix",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "shadow",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 11,
        "x": 110,
        "y": 180,
        "wires": [
            [
                "d869027d9431efc4"
            ],
            [
                "ebcf04a7c62df620"
            ],
            [
                "f739d6707013982c"
            ],
            [
                "056c66f67642fd8f"
            ],
            [
                "bec1627ba76b405e"
            ],
            [
                "5a5aa54bf7a78547"
            ],
            [
                "3816232c6a7c071d"
            ],
            [
                "6c040c32e46a9512"
            ],
            [
                "4b57e38bbb17924e"
            ],
            [
                "5cb6165420781567"
            ],
            [
                "96fb7365808dcd7c",
                "63ae068f91114f13"
            ]
        ]
    },
    {
        "id": "d869027d9431efc4",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: Help",
        "func": "msg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: [\n        'ğŸŒ¬ï¸ Komfovent valdymas',\n        '',\n        'ğŸ“ PagrindinÄ—s komandos:',\n        '/status - Pilna parametrÅ³ suvestinÄ—',\n        '/co2 - â˜ï¸ Anglies dvideginio lygis',\n        '/fan - ğŸ“Š VentiliatoriÅ³ greitis',\n        '/mode - âš™ï¸ Veikimo reÅ¾imas',\n        '/boost - ğŸš€ Aktyvus vÄ—dinimas',\n        '/humidity - ğŸ’§ DrÄ—gmÄ— vonioje',\n        '/outdoor - â˜€ï¸ Lauko temperatÅ«ra',\n        '',\n        'ğŸ“Š PrognozÄ—s:',\n        '/shadow - ğŸ§  Rizikos vertinimas ir prognozÄ—',\n        '/matrix - ğŸ“Š Modelio branda ir duomenÅ³ kiekis',\n        '',\n        'ğŸ§  Gemini AI asistentas:',\n        'â€¢ \"atlik vakar dienos auditÄ…\" â€“ iÅ¡sami paros apÅ¾valga',\n        'â€¢ \"kodÄ—l dabar fan 35%?\" â€“ logÅ³ interpretacija',\n        'â€¢ \"kiek liko filtrÅ³ resursÅ³?\" â€“ filtrÅ³ bÅ«senos analizÄ—',\n        'â€¢ \"palygink CO2 su vakar diena\" â€“ istorinis palyginimas',\n        '',\n        'ğŸ’¡ Atsakymus pateikia Gemini AI.'\n    ].join('\\n')\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 290,
        "y": 100,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "ebcf04a7c62df620",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: /status",
        "func": "const g = global.get('homeassistant') || {};\n\nconst states =\n  (g?.homeAssistant?.states) ||\n  (g?.homeassistant?.states) ||\n  (g?.states) ||\n  {};\n\nconst ents = global.get('komfovent_entities') || {};\n\nfunction isBad(v) {\n  if (v === null || v === undefined) return true;\n  const s = String(v).trim().toLowerCase();\n  return (s === '' || s === 'unknown' || s === 'unavailable' || s === 'nan');\n}\n\nfunction getVal(id, unit = '', dec = 0) {\n  const raw = states[id]?.state;\n  if (isBad(raw)) return 'n/a';\n  const v = parseFloat(raw);\n  return isFinite(v) ? v.toFixed(dec) + unit : 'n/a';\n}\n\nfunction toLt(id) {\n  const raw = states[id]?.state;\n  if (isBad(raw)) return 'n/a';\n  const s = String(raw).toLowerCase();\n  return (s === 'on' || s === 'true') ? 'Aktyvus' : 'IÅ¡jungtas';\n}\n\n/* ===============================\n   Gartraukio bÅ«sena\n   - Light-only ignoruojama\n   - ON >= 75W\n   =============================== */\n\nlet hoodLine = 'ğŸ§¯ Gartraukis: IÅ¡jungta';\n\nconst hoodRaw = states['sensor.hood_socket_power']?.state;\nif (!isBad(hoodRaw)) {\n  const hoodP = parseFloat(hoodRaw);\n  if (isFinite(hoodP) && hoodP >= 75) {\n    const lvl = (hoodP >= 145) ? 3 : (hoodP >= 105) ? 2 : 1;\n    hoodLine = `ğŸ§¯ Gartraukis: Ä®jungta (${lvl} lygis)`;\n  }\n}\n\nconst lines = [\n  `â˜ï¸ COâ‚‚ lygis: ${getVal(ents.co2, ' ppm')}`,\n  `âš™ï¸ Darbo reÅ¾imas: ${states[ents.mode]?.state || 'n/a'}`,\n  `ğŸ“Š VentiliatoriÅ³ greitis: ${getVal(ents.fan_actual, '%')}`,\n  `ğŸŒ¡ï¸ Paduodama temperatÅ«ra: ${getVal(ents.intake_temp, 'Â°C', 1)}`,\n  `â„ï¸ Lauko temperatÅ«ra: ${getVal(ents.outdoor, 'Â°C', 1)}`,\n  `ğŸ’§ DrÄ—gmÄ— vonioje: ${getVal(ents.humidity, '%')}`,\n  `ğŸš€ Aktyvus vÄ—dinimas: ${toLt(ents.boost_ha)}`,\n  hoodLine,\n  `ğŸ”Œ OVR: ${toLt(ents.ovr_ha)}`\n];\n\nmsg.payload = {\n  chatId: msg.chatId,\n  type: 'message',\n  content: lines.join('\\n')\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 140,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "f739d6707013982c",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: /co2",
        "func": "const g = global.get('homeassistant') || {};\nconst states =\n  (g.homeAssistant && g.homeAssistant.states) ? g.homeAssistant.states :\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\nconst ents = global.get('komfovent_entities') || {};\n\nconst raw = states[ents.co2]?.state;\nconst v = parseFloat(raw);\nconst content = isFinite(v) ? `â˜ï¸ COâ‚‚ lygis: ${Math.round(v)} ppm` : `âš ï¸ COâ‚‚ duomenÅ³ nÄ—ra: ${raw}`;\n\nmsg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: content\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 290,
        "y": 180,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "056c66f67642fd8f",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: /fan",
        "func": "const g = global.get('homeassistant') || {};\nconst states =\n  (g.homeAssistant && g.homeAssistant.states) ? g.homeAssistant.states :\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\nconst ents = global.get('komfovent_entities') || {};\n\nconst actual = parseFloat(states[ents.fan_actual]?.state);\nconst content = isFinite(actual)\n    ? `ğŸ“Š VentiliatoriÅ³ greitis: ${Math.round(actual)}%`\n    : `âš ï¸ VentiliatoriÅ³ duomenÅ³ nÄ—ra`;\n\nmsg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: content\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 290,
        "y": 220,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "bec1627ba76b405e",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: /mode",
        "func": "const g = global.get('homeassistant') || {};\nconst states =\n  (g.homeAssistant && g.homeAssistant.states) ? g.homeAssistant.states :\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\nconst ents = global.get('komfovent_entities') || {};\n\nconst m = states[ents.mode]?.state;\nconst content = m ? `âš™ï¸ Darbo reÅ¾imas: ${m}` : `âš ï¸ ReÅ¾imas nenustatytas`;\n\nmsg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: content\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 260,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "5a5aa54bf7a78547",
        "type": "function",
<<<<<<< HEAD
        "z": "6ff955ee3e10e431",
        "name": "Reply: /boost",
        "func": "const g = global.get('homeassistant') || {};\nconst states =\n  (g.homeAssistant && g.homeAssistant.states) ? g.homeAssistant.states :\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\nconst ents = global.get('komfovent_entities') || {};\n\nfunction toLt(id) {\n    const s = String(states[id]?.state || '').toLowerCase();\n    return (s === 'on' || s === 'true') ? 'Aktyvus' : 'IÅ¡jungtas';\n}\n\nconst content = `ğŸš€ Aktyvus vÄ—dinimas (Boost): ${toLt(ents.boost_ha)}`;\n\nmsg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: content\n};\nreturn msg;",
=======
        "z": "8e4fe2eda5888688",
        "name": "Reply: Help",
        "func": "msg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: [\n        'ğŸŒ¬ï¸ Komfovent AI Gateway v5.2.0 (Phase B)',\n        '',\n        'ğŸ“ PagrindinÄ—s komandos:',\n        '/status - VisÅ³ parametrÅ³ suvestinÄ— realiu laiku',\n        '/co2 - DabartinÄ— COâ‚‚ koncentracija (ppm)',\n        '/fan - VentiliatoriÅ³ greitis',\n        '/mode - Aktyvus loginis reÅ¾imas (Naktis, Diena, IÅ¡vykÄ™)',\n        '/humidity - Vonios drÄ—gmÄ—s lygis (%)',\n        '',\n        'ğŸ“Š Predictive v5 (Statistinis Intelektas):',\n        '/shadow - Rizika, prognozÄ— ir Z-score nuokrypis nuo istorinÄ—s normos',\n        '/matrix - Matricos branda (dienos, coverage) ir pasitikÄ—jimo lygis',\n        '',\n        'ğŸ§  Laisvos uÅ¾klausos (Gemini AI):',\n        'â€¢ \"atlik vakar dienos auditÄ…\" â€“ pilna paros analizÄ—',\n        'â€¢ \"paaiÅ¡kink kodÄ—l fan 45%?\" â€“ logÅ³ interpretacija',\n        'â€¢ \"ar filtrai dar geri?\" â€“ filtrÅ³ resursÅ³ patikra',\n        '',\n        'ğŸ’¡ DI sprendimai dabar remiasi 45 dienÅ³ elgsenos matrica.'\n    ].join('\\n')\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 200,
        "wires": [
            [
                "3b5646a6b3bbfec3"
            ]
        ]
    },
    {
        "id": "e3d278f60536fd9a",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Reply: Status",
        "func": "let ha = global.get('homeassistant') || {};\nlet states = ha.states || ha.homeAssistant?.states || {};\nconst ents = global.get('komfovent_entities') || {};\n\nfunction getVal(id, unit = '', dec = 0) {\n    const s = states[id]?.state;\n    const v = parseFloat(s);\n    return isFinite(v) ? v.toFixed(dec) + unit : 'n/a';\n}\n\n// GrieÅ¾tos dvi fazÄ—s pagal jÅ«sÅ³ nurodymÄ…\nfunction toLt(id) {\n    const s = String(states[id]?.state || '').toLowerCase();\n    return (s === 'on' || s === 'true') ? 'Aktyvus' : 'IÅ¡jungtas';\n}\n\nconst lines = [\n    `COâ‚‚ lygis: ${getVal(ents.co2, ' ppm')}`,\n    `Darbo reÅ¾imas: ${states[ents.mode]?.state || 'n/a'}`,\n    `VentiliatoriÅ³ greitis: ${getVal(ents.fan_actual, '%')}`,\n    `Paduodama temperatÅ«ra: ${getVal(ents.intake_temp, 'Â°C', 1)}`,\n    `Lauko temperatÅ«ra: ${getVal(ents.outdoor, 'Â°C', 1)}`,\n    `DrÄ—gmÄ— vonioje: ${getVal(ents.humidity, '%')}`,\n    `Aktyvus vÄ—dinimas (Boost): ${toLt(ents.boost_ha)}`,\n    `OVR (iÅ¡orinis valdymas): ${toLt(ents.ovr_ha)}`\n];\n\nmsg.payload = { chatId: msg.chatId, type: 'message', content: lines.join('\\n') };\nnode.status({ fill: 'green', shape: 'dot', text: 'Statusas v7 paruoÅ¡tas' });\nreturn msg;",
>>>>>>> b58913592a75cf5a86b6acefe8a14e062f21f6ad
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 300,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "3816232c6a7c071d",
        "type": "function",
<<<<<<< HEAD
        "z": "6ff955ee3e10e431",
        "name": "Reply: /humidity",
        "func": "const g = global.get('homeassistant') || {};\nconst states =\n  (g.homeAssistant && g.homeAssistant.states) ? g.homeAssistant.states :\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\nconst ents = global.get('komfovent_entities') || {};\n\nconst v = parseFloat(states[ents.humidity]?.state);\nconst content = isFinite(v)\n    ? `ğŸ’§ DrÄ—gmÄ— vonioje: ${v.toFixed(1)}%`\n    : `âš ï¸ DrÄ—gmÄ—s duomenÅ³ nÄ—ra`;\n\nmsg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: content\n};\nreturn msg;",
=======
        "z": "8e4fe2eda5888688",
        "name": "Reply: /fan",
        "func": "let ha = global.get('homeassistant') || {};\nlet states = (ha?.homeAssistant?.states) || (ha?.homeassistant?.states) || (ha?.states) || {};\nconst a = parseFloat(states?.['sensor.intake_fan_level_current']?.state);\nconst d = parseFloat(states?.['number.intake_level_1']?.state);\nconst aTxt = isFinite(a) ? Math.round(a)+'%' : 'n/a';\nconst dTxt = isFinite(d) ? Math.round(d)+'%' : 'n/a';\nmsg.payload = { chatId: msg.chatId, type: 'message', content: `Fan speed: ${aTxt}` };\nreturn msg;",
>>>>>>> b58913592a75cf5a86b6acefe8a14e062f21f6ad
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
<<<<<<< HEAD
        "x": 300,
=======
        "x": 330,
>>>>>>> b58913592a75cf5a86b6acefe8a14e062f21f6ad
        "y": 340,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "6c040c32e46a9512",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: /outdoor",
        "func": "const g = global.get('homeassistant') || {};\nconst states =\n  (g.homeAssistant && g.homeAssistant.states) ? g.homeAssistant.states :\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\n    ((g.homeassistant && g.homeassistant.states) ? g.homeassistant.states :\n      (g.states || {}));\n\nconst ents = global.get('komfovent_entities') || {};\n\nconst v = parseFloat(states[ents.outdoor]?.state);\nlet content = \"\";\n\nif (isFinite(v)) {\n    // 1. Parenkame ikonÄ… pagal temperatÅ«rÄ…\n    let icon = (v >= 10) ? \"â˜€ï¸\" : \"â„ï¸\";\n    content = `${icon} Lauko temperatÅ«ra: ${v.toFixed(1)}Â°C\\n`;\n\n    // 2. Pridedame Å¡eimos rekomendacijas\n    if (v <= -10) {\n        content += \"\\nğŸ§¤ Vaikams reikia Å¾ieminiÅ³ drabuÅ¾iÅ³!\";\n    }\n\n    if (v <= 0) {\n        content += \"\\nğŸš— Laikas paÅ¡ildyti automobilÄ¯.\";\n    } else if (v > 0 && v < 10) {\n        content += \"\\nğŸ§¥ Lauke vÄ—su, nepamirÅ¡kite striukiÅ³.\";\n    } else if (v >= 20) {\n        content += \"\\nğŸ˜ Puikus oras pasivaikÅ¡Äiojimui!\";\n    }\n} else {\n    content = \"âš ï¸ Lauko temperatÅ«ros duomenÅ³ nÄ—ra\";\n}\n\nmsg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: content\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 380,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "96fb7365808dcd7c",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Build AI context (paths)",
        "func": "// Nustatomi keliai iki visÅ³ logÅ³ failÅ³ ir bÅ«senos failÅ³ AI kontekstui.\n// PATAISYMAS: Ä®trauktas filters_state.json kelias.\n\nconst TZ = 'Europe/Vilnius';\nconst logBase = '/data/logs/komfovent';\nconst stateBase = '/data/state/komfovent';\n\nfunction ltDate(d) {\n  return new Intl.DateTimeFormat('sv-SE', {\n    timeZone: TZ,\n    year: 'numeric',\n    month: '2-digit',\n    day: '2-digit'\n  }).format(d);\n}\n\nconst day = ltDate(new Date());\n\nmsg._logPaths = {\n  telemetry: `${logBase}/komfovent_telemetry_${day}.jsonl`,\n  control: `${logBase}/komfovent_control_${day}.jsonl`,\n  predictive: `${logBase}/komfovent_predictive_${day}.jsonl`,\n  filters: `${logBase}/komfovent_filters_${day}.jsonl`,\n  matrix: `${stateBase}/prediction_matrix.json`,\n  filters_state: `${stateBase}/filters_state.json`\n};\n\nnode.status({ fill: \"blue\", shape: \"dot\", text: `Paths ready for ${day}` });\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 500,
        "wires": [
            [
                "eb5198f89b492515"
            ]
        ]
    },
    {
        "id": "eb5198f89b492515",
        "type": "function",
<<<<<<< HEAD
        "z": "6ff955ee3e10e431",
        "name": "Tail telemetry cmd",
        "func": "const p = msg._logPaths || {};\n\n// Skaitome bÅ«senos failus ir ribotÄ… logÅ³ istorijÄ… (balansas tarp konteksto ir stabilumo).\n// - Telemetry: 50 eiluÄiÅ³ (tendencijoms)\n// - Control: 30 eiluÄiÅ³ (paskutiniai sprendimai / OVR / HOOD / boost)\n// - Predictive: 20 eiluÄiÅ³\n// - Filters: 10 eiluÄiÅ³\n\nmsg.payload = `bash -lc '` +\n  `if [ -f \"${p.matrix}\" ]; then echo \"=== MATRIX ===\"; cat \"${p.matrix}\"; fi; ` +\n  `if [ -f \"${p.filters_state}\" ]; then echo \"=== FILTERS_STATE ===\"; cat \"${p.filters_state}\"; fi; ` +\n  `if [ -f \"${p.telemetry}\" ] && [ \"${p.telemetry}\" != \"undefined\" ]; then echo \"=== $(basename ${p.telemetry}) ===\"; tail -n 50 \"${p.telemetry}\"; fi; ` +\n  `if [ -f \"${p.control}\" ] && [ \"${p.control}\" != \"undefined\" ]; then echo \"=== $(basename ${p.control}) ===\"; tail -n 30 \"${p.control}\"; fi; ` +\n  `if [ -f \"${p.predictive}\" ] && [ \"${p.predictive}\" != \"undefined\" ]; then echo \"=== $(basename ${p.predictive}) ===\"; tail -n 20 \"${p.predictive}\"; fi; ` +\n  `if [ -f \"${p.filters}\" ] && [ \"${p.filters}\" != \"undefined\" ]; then echo \"=== $(basename ${p.filters}) ===\"; tail -n 10 \"${p.filters}\"; fi; ` +\n  `'`;\n\nnode.status({ fill: \"blue\", shape: \"dot\", text: \"Reading logs: T50 C30 P20 F10\" });\n\nreturn msg;",
=======
        "z": "8e4fe2eda5888688",
        "name": "Build AI context (paths)",
        "func": "// Nustatomi keliai iki visÅ³ logÅ³ failÅ³ ir bÅ«senos failÅ³ AI kontekstui.\n// PATAISYMAS: Ä®trauktas filters_state.json kelias.\n\nconst TZ = 'Europe/Vilnius';\nconst logBase = '/data/logs/komfovent';\nconst stateBase = '/data/state/komfovent';\n\nfunction ltDate(d) {\n  return new Intl.DateTimeFormat('sv-SE', {\n    timeZone: TZ,\n    year: 'numeric',\n    month: '2-digit',\n    day: '2-digit'\n  }).format(d);\n}\n\nconst day = ltDate(new Date());\n\nmsg._logPaths = {\n  telemetry: `${logBase}/komfovent_telemetry_${day}.jsonl`,\n  control: `${logBase}/komfovent_control_${day}.jsonl`,\n  predictive: `${logBase}/komfovent_predictive_${day}.jsonl`,\n  filters: `${logBase}/komfovent_filters_${day}.jsonl`,\n  matrix: `${stateBase}/prediction_matrix.json`,\n  filters_state: `${stateBase}/filters_state.json`\n};\n\nnode.status({ fill: \"blue\", shape: \"dot\", text: `Paths ready for ${day}` });\n\nreturn msg;",
>>>>>>> b58913592a75cf5a86b6acefe8a14e062f21f6ad
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 570,
        "y": 500,
        "wires": [
            [
                "cde32ceab90e3ab7"
            ]
        ]
    },
    {
<<<<<<< HEAD
        "id": "cde32ceab90e3ab7",
=======
        "id": "5c3f116273e2bc12",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Tail telemetry cmd",
        "func": "// Agreguoja visÅ³ moduliÅ³ paskutinius Ä¯raÅ¡us ir bÅ«senos failus AI asistentui.\n// PATAISYMAS: Ä®trauktas pilnas filtrÅ³ bÅ«senos failo nuskaitymas.\n\nconst p = msg._logPaths || {};\n\n// Skaitome bÅ«senos failus (visÄ… turinÄ¯) ir logÅ³ failus (paskutines 100 eiluÄiÅ³).\nmsg.payload = `bash -lc '` +\n    `if [ -f \"${p.matrix}\" ]; then echo \"=== MATRIX ===\"; cat \"${p.matrix}\"; fi; ` +\n    `if [ -f \"${p.filters_state}\" ]; then echo \"=== FILTERS_STATE ===\"; cat \"${p.filters_state}\"; fi; ` +\n    `for f in ${p.telemetry} ${p.control} ${p.predictive} ${p.filters}; do ` +\n    `if [ -f \"$f\" ] && [ \"$f\" != \"undefined\" ]; then echo \"=== $(basename $f) ===\"; tail -n 100 \"$f\"; fi; ` +\n    `done'`;\n\nnode.status({ fill: \"blue\", shape: \"dot\", text: \"Reading logs and state\" });\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 580,
        "wires": [
            [
                "e17bd67575a09940"
            ]
        ]
    },
    {
        "id": "e17bd67575a09940",
>>>>>>> b58913592a75cf5a86b6acefe8a14e062f21f6ad
        "type": "exec",
        "z": "6ff955ee3e10e431",
        "command": "",
        "addpay": true,
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": false,
        "name": "Exec: tail telemetry (stdout only)",
        "x": 830,
        "y": 500,
        "wires": [
            [
                "47276443c90c79c0"
            ],
            [],
            []
        ]
    },
    {
        "id": "47276443c90c79c0",
        "type": "function",
<<<<<<< HEAD
        "z": "6ff955ee3e10e431",
        "name": "Capture All Logs",
        "func": "// PATAISYMAS: LogÅ³ duomenys perkeliami Ä¯ saugÅ³ kintamÄ…jÄ¯.\nlet out = msg.payload;\nif (Buffer.isBuffer(out)) out = out.toString('utf8');\n\nconst logs = String(out || '').trim();\n\n// IÅ¡saugome logus prompt builder'iui\nmsg._all_logs_context = logs;\n\n// Toliau nebevykdom papildomo Exec, todÄ—l msg.payload nekeiÄiam.\n\nif (logs.length > 0) {\n    node.status({ fill: \"green\", shape: \"dot\", text: `Surinkta ${logs.length} simboliÅ³` });\n} else {\n    node.status({ fill: \"yellow\", shape: \"ring\", text: \"LogÅ³ failai tuÅ¡ti\" });\n}\n\nreturn msg;",
=======
        "z": "8e4fe2eda5888688",
        "name": "Capture All Logs",
        "func": "// PATAISYMAS: LogÅ³ duomenys perkeliami Ä¯ saugÅ³ kintamÄ…jÄ¯.\nlet out = msg.payload;\nif (Buffer.isBuffer(out)) out = out.toString('utf8');\n\nconst logs = String(out || '').trim();\n\n// IÅ¡saugome logus prompt builder'iui\nmsg._all_logs_context = logs;\n\n// Saugus pass-through sekanÄiam Exec mazgui\nmsg.payload = \"true\";\n\nif (logs.length > 0) {\n    node.status({ fill: \"green\", shape: \"dot\", text: `Surinkta ${logs.length} simboliÅ³` });\n} else {\n    node.status({ fill: \"yellow\", shape: \"ring\", text: \"LogÅ³ failai tuÅ¡ti\" });\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1180,
        "y": 580,
        "wires": [
            [
                "1236d6461e4f2730"
            ]
        ]
    },
    {
        "id": "1236d6461e4f2730",
        "type": "exec",
        "z": "8e4fe2eda5888688",
        "command": "",
        "addpay": true,
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": false,
        "name": "Exec: tail control (stdout only)",
        "x": 910,
        "y": 640,
        "wires": [
            [
                "3c0242bc1b5207ae"
            ],
            [],
            []
        ]
    },
    {
        "id": "3c0242bc1b5207ae",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Build prompt (1 message)",
        "func": "// Galutinis prompt builderis su schema v7 duomenimis ir grieÅ¾tomis taisyklÄ—mis\nconst rawData = msg._all_logs_context || \"\";\nconst matrix = global.get('prediction_matrix') || {};\nconst ents = global.get('komfovent_entities') || {};\nconst g = global.get('homeassistant') || {};\nconst states = g.states || g.homeAssistant?.states || g.homeassistant?.states || {};\n\n// PagalbinÄ— funkcija rasti reikÅ¡mes loguose\nfunction findVal(key, text) {\n  const regex = new RegExp(`\"${key}\"\\\\s*:\\\\s*([\\\\d.]+)`, 'g');\n  const matches = Array.from(text.matchAll(regex));\n  return matches.length > 0 ? matches[matches.length - 1][1] : null;\n}\n\n// Saugus bÅ«senos gavimas\nconst getS = (id) => {\n  const s = states[id]?.state;\n  return (s === 'unknown' || s === 'unavailable' || !s) ? 'neÅ¾inoma' : s;\n};\n\n// FazÄ—s: Aktyvus arba IÅ¡jungtas\nconst ovrStatus = (String(states[ents.ovr_ha]?.state).toLowerCase() === 'on') ? 'Aktyvus' : 'IÅ¡jungtas';\nconst boostStatus = (String(states[ents.boost_ha]?.state).toLowerCase() === 'on') ? 'Aktyvus' : 'IÅ¡jungtas';\n\nconst snap = {\n  temp: getS(ents.intake_temp),\n  ovr: ovrStatus,\n  boost: boostStatus,\n  co2: getS(ents.co2),\n  fan: getS(ents.fan_actual),\n  hum: getS(ents.humidity),\n  branda: matrix.training_days_actual || 0\n};\n\nmsg.ai_prompt = `Esi namÅ³ inÅ¾ineriniÅ³ sistemÅ³ ekspertas. RaÅ¡yk tik LIETUVIÅ KAI.\n\nSISTEMOS FAKTAI:\n- Paduodama temperatÅ«ra: ${snap.temp} laipsniÅ³.\n- IÅ¡orinis valdymas (OVR): ${snap.ovr}.\n- Aktyvus vÄ—dinimas (Boost): ${snap.boost}.\n- CO2 lygis: ${snap.co2} ppm.\n- VentiliatoriÅ³ greitis: ${snap.fan} procentÅ³.\n- DrÄ—gmÄ— vonioje: ${snap.hum} procentÅ³.\n- Matricos branda: ${snap.branda} dienos.\n\nTAISYKLÄ–S ATSAKYMUI (GRIEÅ½TAI):\n1. NENAUDOK JOKIÅ² Å½VAIGÅ½DUÄŒIÅ² (*). Atsakyk tik paprastu tekstu be formatavimo.\n2. ATSAKYMÄ„ PRADÄ–K NUO FAKTO. Nenaudok \"AtsipraÅ¡au\", \"Galiu pasakyti\" ar \"AtsiÅ¾velgiant Ä¯\".\n3. KALBÄ–K KAIP Å½MOGUS. Niekada nenaudok techniniÅ³ terminÅ³ su kabutÄ—mis ar lygybÄ—s Å¾enklais (pvz., nenaudok \"training_days_actual\":0). Vietoj to sakyk \"duomenys kaupiami ${snap.branda} dienÅ³\".\n4. Jei matai, kad skaiÄius yra (pvz. ${snap.temp}), niekada nesakyk \"duomenÅ³ neturiu\".\n5. Atsakymas turi bÅ«ti trumpas ir draugiÅ¡kas, iki 3 sakiniÅ³.\n\nKLAUSIMAS: ${msg.user_text}`;\n\nreturn msg;",
>>>>>>> b58913592a75cf5a86b6acefe8a14e062f21f6ad
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 290,
        "y": 580,
        "wires": [
            [
                "cdf0a918f5808d27"
            ]
        ]
    },
    {
        "id": "5d49fc4b1470e1ec",
        "type": "telegram sender",
        "z": "6ff955ee3e10e431",
        "name": "Telegram Out",
        "bot": "tg_bot_cfg_komfovent",
        "outputs": 1,
        "x": 540,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "63ae068f91114f13",
        "type": "link out",
        "z": "6ff955ee3e10e431",
        "name": "AI Out: Control Query",
        "mode": "link",
        "links": [
            "2ce33c61ffe1a0b7",
            "9932214e75174d30"
        ],
        "x": 65,
        "y": 340,
        "wires": []
    },
    {
        "id": "5e34d037680f59dc",
        "type": "link in",
        "z": "6ff955ee3e10e431",
        "name": "AI In: Control Context",
        "links": [
            "a16e0aa2028bc8af"
        ],
        "x": 515,
        "y": 220,
        "wires": [
            [
                "ea555fdc1f28ec24"
            ]
        ]
    },
    {
        "id": "ea555fdc1f28ec24",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Store last Control Context",
        "func": "// 1. IÅ¡saugom kontekstÄ… (naudojama AI asistento atminties palaikymui)\nconst ctx = msg.payload;\nflow.set('control_context_last', ctx);\n\n// 2. Identifikuojam praneÅ¡imÄ… (ar tai prognozÄ—, ar tai auditas)\nconst isShadow = (typeof ctx === 'string' && ctx.includes('Gemini Å eÅ¡Ä—linÄ— AnalizÄ—'));\nconst isAudit = (typeof ctx === 'string' && ctx.includes('AUDITAS')) || msg._is_audit;\n\n// 3. Jei tai viena iÅ¡ DI ataskaitÅ³ - siunÄiam Ä¯ Telegram\nif (isShadow || isAudit) {\n    const ALLOWED = Number(env.get(\"MY_TELEGRAM_ID\")) || global.get(\"ALLOWED_TELEGRAM_ID\");\n\n    msg.payload = {\n        chatId: ALLOWED,\n        type: 'message',\n        content: ctx\n    };\n\n    node.status({ fill: 'green', shape: 'dot', text: isAudit ? 'siunÄiamas auditas' : 'siunÄiama prognozÄ—' });\n    return msg;\n}\n\n// 4. Jei tai paprastas praneÅ¡imas (debug) - sustojam\nnode.status({ fill: 'gray', shape: 'ring', text: 'ignoruota (ne DI)' });\nreturn null;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 220,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "4b57e38bbb17924e",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: /matrix",
        "func": "const m = global.get('prediction_matrix') || {};\nif (!m.data) {\n    msg.payload = { chatId: msg.chatId, type: 'message', content: 'âŒ Matrica dar nesugeneruota. Laukite naktinio mokymosi (03:05).' };\n    return msg;\n}\nconst ci = m.confidence_info || {};\nconst lines = [\n    `ğŸ“Š Modelio versija: v${m.model_ver || '6.1'}`,\n    `ğŸ“… Mokymosi laikas: ${m.training_days_actual || 0} d.`,\n    `ğŸ“ˆ Tikslumas: ${(ci.level || 'n/a').toUpperCase()}`,\n    `ğŸš€ ReÅ¾imas: ${ci.is_live_ready ? 'Aktyvus' : 'Shadow mode'}`,\n    `ğŸ•’ Generuota: ${m.generated_at ? new Date(m.generated_at).toLocaleString('lt-LT') : 'n/a'}`\n];\nmsg.payload = { chatId: msg.chatId, type: 'message', content: lines.join('\\n') };\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 420,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "5cb6165420781567",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Reply: /shadow",
        "func": "const u = flow.get('predictive_last') || {};\n\nif (!u.ts) {\n    msg.payload = {\n        chatId: msg.chatId,\n        type: 'message',\n        content: 'âš ï¸ Predictive Ä¯raÅ¡Å³ dar nÄ—ra.'\n    };\n    return msg;\n}\n\nconst lines = [\n    `ğŸ§  PrognozÄ—s rizika: ${u.risk_score || 0}/10`,\n    `ğŸ’¨ COâ‚‚ pokytis: ${u.co2} â†’ ${u.co2_f_30} ppm (+30m)`,\n    `ğŸ¯ Z-Score (COâ‚‚/Rate): ${(u.z_co2 || 0).toFixed(2)} / ${(u.z_rate || 0).toFixed(2)}`,\n    `ğŸ“œ Statusas: ${String(u.anomaly_status || 'normal').toUpperCase()}`,\n    `ğŸ› ï¸ Rizikos korekcija: +${u.risk_adjust || 0}`\n];\n\nmsg.payload = {\n    chatId: msg.chatId,\n    type: 'message',\n    content: lines.join('\\n')\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 460,
        "wires": [
            [
                "5d49fc4b1470e1ec"
            ]
        ]
    },
    {
        "id": "cdf0a918f5808d27",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Build prompt (1 message)",
        "func": "// Galutinis prompt builderis (viena Å¾inutÄ—)\nconst rawLogs = msg._all_logs_context || \"LogÅ³ duomenÅ³ nÄ—ra.\";\nconst matrix = global.get('prediction_matrix') || {};\nconst ents = global.get('komfovent_entities') || {};\nconst g = global.get('homeassistant') || {};\nconst states =\n  (g?.homeAssistant?.states) || (g?.homeassistant?.states) || (g?.states) || {};\n\n// Saugus bÅ«senos gavimas\nconst getS = (id) => {\n  const s = states[id]?.state;\n  return (s === 'unknown' || s === 'unavailable' || s === undefined || s === null || String(s).trim() === '') ? 'neÅ¾inoma' : s;\n};\n\n// Matricos techniniÅ³ duomenÅ³ paruoÅ¡imas\nconst matrixStats = {\n  training_days: matrix.training_days_actual || 0,\n  raw_data_summary: matrix.data ? JSON.stringify(matrix.data).slice(0, 500) : \"NÄ—ra duomenÅ³\"\n};\n\nconst ovrStatus = (String(states[ents.ovr_ha]?.state).toLowerCase() === 'on') ? 'Aktyvus' : 'IÅ¡jungtas';\nconst boostStatus = (String(states[ents.boost_ha]?.state).toLowerCase() === 'on') ? 'Aktyvus' : 'IÅ¡jungtas';\n\n// Gartraukis pagal rozetÄ—s galiÄ… (ignoruoja vien apÅ¡vietimÄ…)\nconst hoodPowerRaw = states['sensor.hood_socket_power']?.state;\nconst hoodPower = (hoodPowerRaw === undefined || hoodPowerRaw === null) ? NaN : parseFloat(hoodPowerRaw);\nconst hoodOn = Number.isFinite(hoodPower) && hoodPower >= 75;\nconst hoodLevel = hoodOn ? ((hoodPower >= 145) ? 3 : (hoodPower >= 105) ? 2 : 1) : null;\n\n// Paskutinio OVR aktyvavimo laikas iÅ¡ pateikto logÅ³ fragmento\nlet lastOvrOnTs = null;\ntry {\n  const lines = String(rawLogs).split('\\n');\n  for (const line of lines) {\n    const t = line.trim();\n    if (!t.startsWith('{') || !t.endsWith('}')) continue;\n    let obj;\n    try { obj = JSON.parse(t); } catch (e) { continue; }\n    const ts = obj.ts || obj.timestamp || obj.time || null;\n    // Galimi lauko variantai\n    const v = (obj.ovr !== undefined) ? obj.ovr :\n              (obj.ovr_active !== undefined) ? obj.ovr_active :\n              (obj.desired && obj.desired.ovr !== undefined) ? obj.desired.ovr :\n              (obj.d && obj.d.ovr !== undefined) ? obj.d.ovr : undefined;\n    if (v === undefined) continue;\n    const s = String(v).toLowerCase();\n    const isOn = (v === true) || (s === 'true') || (s === 'on') || (s === 'active') || (s === '1');\n    if (isOn && ts) lastOvrOnTs = ts;\n  }\n} catch (e) {\n  // jei kaÅ¾kas blogai su logÅ³ tekstu, tiesiog paliekam null\n}\n\nconst snap = {\n  temp: getS(ents.intake_temp),\n  ovr: ovrStatus,\n  ovr_last_on_ts: lastOvrOnTs || 'nerasta pateiktame fragmente',\n  boost: boostStatus,\n  co2: getS(ents.co2),\n  fan: getS(ents.fan_actual),\n  hum: getS(ents.humidity),\n  hood: {\n    on: hoodOn,\n    level: hoodLevel,\n    power_w: Number.isFinite(hoodPower) ? hoodPower : 'neÅ¾inoma'\n  }\n};\n\nconst hoodLine = snap.hood.on ? `Ä®jungta (${snap.hood.level} lygis)` : 'IÅ¡jungta';\n\nmsg.ai_prompt = `Esi namÅ³ inÅ¾ineriniÅ³ sistemÅ³ ekspertas. RaÅ¡yk tik LIETUVIÅ KAI.\n\nSISTEMOS FAKTAI:\n- Paduodama temperatÅ«ra: ${snap.temp} laipsniÅ³.\n- IÅ¡orinis valdymas (OVR): ${snap.ovr}.\n- Paskutinis OVR aktyvavimas (iÅ¡ pateikto logÅ³ fragmento): ${snap.ovr_last_on_ts}.\n- Aktyvus vÄ—dinimas (Boost): ${snap.boost}.\n- CO2 lygis: ${snap.co2} ppm.\n- VentiliatoriÅ³ greitis: ${snap.fan} procentÅ³.\n- DrÄ—gmÄ— vonioje: ${snap.hum} procentÅ³.\n- Gartraukis: ${hoodLine}.\n\nELGSENOS MODELIO STATUSAS (naudok tik jei klausiama apie tendencijas):\n- Matricos branda: ${matrixStats.training_days} dienos.\n- Matricos techninÄ— iÅ¡trauka: ${matrixStats.raw_data_summary}.\n\nTAISYKLÄ–S ATSAKYMUI (GRIEÅ½TAI):\n1. NENAUDOK JOKIÅ² Å½VAIGÅ½DUÄŒIÅ² (*). Atsakyk tik paprastu tekstu.\n2. ATSAKYK TIK Ä® TAI, KO KLAUSIAMA. Niekada neminÄ—k matricos brandos ar duomenÅ³ kaupimo laiko, nebent vartotojas to tiesiogiai paklaustÅ³.\n3. KALBÄ–K KAIP Å½MOGUS, TRUMPAI (iki 2-3 sakiniÅ³).\n4. Jei klausiama \"kada paskutinÄ¯ kartÄ…\", pirmiausia ieÅ¡kok Ä¯vykio Å¾emiau esanÄiame logÅ³ kontekste. Jei Ä¯vykio tame fragmente nÄ—ra, taip ir paraÅ¡yk.\n\nKONTEKSTAS IÅ  LOGÅ²:\n${rawLogs}\n\nKLAUSIMAS: ${msg.user_text}`;\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 580,
        "wires": [
            [
                "433da280ca0fe8f5"
            ]
        ]
    },
    {
        "id": "433da280ca0fe8f5",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Prepare Gemini request",
        "func": "const MODEL = 'gemini-2.0-flash';\nconst API_KEY = (typeof env !== 'undefined' && env.get) ? env.get('GEMINI_API_KEY') : null;\nconst key = API_KEY || flow.get('GEMINI_API_KEY');\n\nif (!key) {\n  node.status({ fill: 'red', shape: 'ring', text: 'No GEMINI_API_KEY' });\n  msg.payload = { chatId: msg.chatId, type: 'message', content: 'AI neveikia: nÄ—ra GEMINI_API_KEY.' };\n  return [msg, null];\n}\n\nmsg.method = 'POST';\nmsg.url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`;\nmsg.headers = { 'Content-Type': 'application/json' };\n\nmsg.payload = {\n  contents: [\n    { role: 'user', parts: [ { text: msg.ai_prompt } ] }\n  ],\n  generationConfig: {\n    temperature: 0.3,\n    maxOutputTokens: 650\n  }\n};\n\nnode.status({ fill: 'blue', shape: 'dot', text: 'AI request...' });\nreturn [null, msg];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 580,
        "wires": [
            [],
            [
                "5944086c10a6f826"
            ]
        ]
    },
    {
        "id": "5944086c10a6f826",
        "type": "http request",
        "z": "6ff955ee3e10e431",
        "name": "HTTP â†’ Gemini",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": true,
        "headers": [],
        "x": 1020,
        "y": 580,
        "wires": [
            [
                "de086cbcb3ed9711"
            ]
        ]
    },
    {
        "id": "de086cbcb3ed9711",
        "type": "function",
        "z": "6ff955ee3e10e431",
        "name": "Parse Gemini â†’ Telegram (single msg)",
        "func": "let txt = '';\nlet errTxt = '';\n\nif (msg.statusCode && msg.statusCode >= 400) {\n  const e = msg.payload?.error?.message || JSON.stringify(msg.payload);\n  errTxt = `AI klaida (${msg.statusCode}): ${e}`;\n}\n\nif (!errTxt) {\n  try {\n    const parts = msg.payload?.candidates?.[0]?.content?.parts;\n    if (Array.isArray(parts) && parts.length) {\n      txt = parts.map(p => p.text).filter(Boolean).join('\\n');\n    }\n  } catch (e) {}\n}\n\nif (!txt && errTxt) txt = errTxt;\nif (!txt) txt = 'AI atsakymas tuÅ¡Äias / nepavyko perskaityti.';\n\nconst MAX = 3800;\nif (txt.length > MAX) {\n  txt = txt.slice(0, MAX) + '\\n\\n(â€¦sutruminta, nes per ilga vienai Å¾inutei)';\n}\n\nmsg.payload = { chatId: msg.chatId, type: 'message', content: txt };\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1190,
        "y": 480,
        "wires": [
            [
<<<<<<< HEAD
                "5d49fc4b1470e1ec"
=======
                "3b5646a6b3bbfec3"
            ]
        ]
    },
    {
        "id": "3b5646a6b3bbfec3",
        "type": "telegram sender",
        "z": "8e4fe2eda5888688",
        "name": "Telegram Out",
        "bot": "tg_bot_cfg_komfovent",
        "outputs": 1,
        "x": 560,
        "y": 260,
        "wires": [
            []
        ]
    },
    {
        "id": "567de76b7fee6e80",
        "type": "link out",
        "z": "8e4fe2eda5888688",
        "name": "AI Out: Control Query",
        "mode": "link",
        "links": [],
        "x": 595,
        "y": 440,
        "wires": []
    },
    {
        "id": "2c73cea35fecb95c",
        "type": "link in",
        "z": "8e4fe2eda5888688",
        "name": "AI In: Control Context",
        "links": [
            "a16e0aa2028bc8af"
        ],
        "x": 655,
        "y": 520,
        "wires": [
            [
                "3a7613b5066d1102"
            ]
        ]
    },
    {
        "id": "3a7613b5066d1102",
        "type": "function",
        "z": "8e4fe2eda5888688",
        "name": "Store last Control Context",
        "func": "// 1. IÅ¡saugom kontekstÄ… (naudojama AI asistento atminties palaikymui)\nconst ctx = msg.payload;\nflow.set('control_context_last', ctx);\n\n// 2. Identifikuojam praneÅ¡imÄ… (ar tai prognozÄ—, ar tai auditas)\nconst isShadow = (typeof ctx === 'string' && ctx.includes('Gemini Å eÅ¡Ä—linÄ— AnalizÄ—'));\nconst isAudit = (typeof ctx === 'string' && ctx.includes('AUDITAS')) || msg._is_audit;\n\n// 3. Jei tai viena iÅ¡ DI ataskaitÅ³ - siunÄiam Ä¯ Telegram\nif (isShadow || isAudit) {\n    const ALLOWED = Number(env.get(\"MY_TELEGRAM_ID\")) || global.get(\"ALLOWED_TELEGRAM_ID\");\n\n    msg.payload = {\n        chatId: ALLOWED,\n        type: 'message',\n        content: ctx\n    };\n\n    node.status({ fill: 'green', shape: 'dot', text: isAudit ? 'siunÄiamas auditas' : 'siunÄiama prognozÄ—' });\n    return msg;\n}\n\n// 4. Jei tai paprastas praneÅ¡imas (debug) - sustojam\nnode.status({ fill: 'gray', shape: 'ring', text: 'ignoruota (ne DI)' });\nreturn null;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 850,
        "y": 500,
        "wires": [
            [
                "3b5646a6b3bbfec3"
>>>>>>> b58913592a75cf5a86b6acefe8a14e062f21f6ad
            ]
        ]
    },
    {
        "id": "tg_bot_cfg_komfovent",
        "type": "telegram bot",
        "botname": "VentiliationBot",
        "usernames": "",
        "chatids": "",
        "baseapiurl": "",
        "testenvironment": false,
        "updatemode": "polling",
        "addressfamily": "4",
        "pollinterval": "2",
        "usesocks": false,
        "sockshost": "",
        "socksport": "6667",
        "socksusername": "anonymous",
        "sockspassword": "",
        "bothost": "",
        "botpath": "",
        "localbothost": "",
        "localbotport": "8443",
        "publicbotport": "8443",
        "privatekey": "",
        "certificate": "",
        "useselfsignedcertificate": false,
        "sslterminated": false,
        "verboselogging": false
    },
    {
<<<<<<< HEAD
        "id": "a7dfefd6b7229f54",
=======
        "id": "7b760500aab08108",
>>>>>>> b58913592a75cf5a86b6acefe8a14e062f21f6ad
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-telegrambot": "17.0.5"
        }
    }
]
