[
    {
        "id": "b25879043e0541ce",
        "type": "tab",
        "label": "Komfovent - Module: Predictive",
        "disabled": false,
        "info": ""
    },
    {
        "id": "2d3f9c5f878047c1",
        "type": "inject",
        "z": "b25879043e0541ce",
        "name": "Scheduler: Shadow Tick (10 min)",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "600",
        "crontab": "",
        "once": true,
        "onceDelay": 2,
        "topic": "shadow_tick",
        "payload": "",
        "payloadType": "date",
        "x": 180,
        "y": 80,
        "wires": [
            [
                "216dfb37147a485d"
            ]
        ]
    },
    {
        "id": "216dfb37147a485d",
        "type": "function",
        "z": "b25879043e0541ce",
        "name": "Predictive: Shadow Compute",
        "func": "/**\n * Predictive Shadow Compute v6.0\n * Pataisymai: \n * - GrÄ…Å¾ina [msg, msgAi] (abi iÅ¡vestys veikia) \n * - Prideda log_type: 'predictive' \n * - Dvigubas Z-Score (CO2 ir Rate) \n * - Graduotas risk_adjust \n */\n\nfunction clamp(min, max, v) { return Math.max(min, Math.min(max, v)); }\n\nconst matrix = global.get('prediction_matrix') || null;\nconst TZ = 'Europe/Vilnius';\nconst schema_ver = 6;\nconst flow_ver = String(global.get('system_version') || '4.3.1');\n\n// 1. Realaus laiko duomenys (Source of Truth)\nconst co2 = Number(global.get('komfovent.last_co2') || 0);\nconst rate = Number(global.get('komfovent.telemetry_rate') || 0);\nconst threshold = Number(global.get('komfovent.auto_co2_on_threshold') || 750);\nconst alarm = global.get('homeassistant')?.states?.['alarm_control_panel.home']?.state || 'armed_away';\nconst occupied = (alarm === 'disarmed');\n\n// 2. Laiko ir matricos kontekstas\nconst now = new Date();\nconst bucket = Math.floor((now.getHours() * 60 + now.getMinutes()) / 60); // 60 min bucket\nconst dowNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];\nconst dow = dowNames[now.getDay()];\n\nconst matrixKey = `${dow}_${bucket}_${occupied}`;\nlet hist = (matrix && matrix.data) ? matrix.data[matrixKey] : null;\n\n// 3. Z-Score skaiÄiavimas\nlet zCo2 = 0, zRate = 0;\nif (hist) {\n  if (hist.std_co2 > 0) zCo2 = (co2 - hist.mean_co2) / hist.std_co2;\n  if (hist.std_rate > 0) zRate = (rate - hist.mean_rate) / hist.std_rate;\n}\n\nconst zLead = Math.max(zCo2, zRate);\nlet anomalyStatus = hist ? (zLead > 2.0 ? 'above_normal' : (zLead < -2.0 ? 'below_normal' : 'normal')) : 'no_history';\n\n// 4. Rizika ir Confidence\nconst confLevel = matrix?.confidence_info?.level || 'low';\nconst confActionable = (confLevel === 'high' || confLevel === 'very_high');\n\nconst f30 = Math.round(co2 + rate * 30);\nconst f60 = Math.round(co2 + rate * 60);\n\n// BazinÄ— rizika pagal prognozÄ™\nlet baseRisk = 0;\nif (f30 >= threshold) baseRisk = 6;\nelse if (f60 >= (threshold - 50)) baseRisk = 3;\nelse if (rate > 0.5) baseRisk = 1;\n\n// StatistiÅ¡kai pagrÄ¯stas rizikos didinimas\nlet riskAdjust = (confActionable && anomalyStatus === 'above_normal') ? clamp(0, 3, Math.floor(zLead)) : 0;\nconst riskScore = clamp(0, 10, baseRisk + riskAdjust);\n\n// 5. IÅ¡vestis 1: LOG Ä®RAÅ AS (Logging moduliui)\nconst rec = {\n  schema_ver,\n  flow_ver,\n  module: 'predictive',\n  kind: 'shadow_tick',\n  ts: new Date().toISOString(),\n  occupied,\n  alarm_state: alarm,\n  dow,\n  hour: now.getHours(),\n  co2,\n  rate: Number(rate.toFixed(2)),\n  co2_f_30: f30,\n  co2_f_60: f60,\n  matrix_key: matrixKey,\n  matrix_confidence_level: confLevel,\n  matrix_training_days: matrix?.training_days_actual || 0,\n  history_mean_co2: hist ? hist.mean_co2 : null,\n  history_mean_rate: hist ? hist.mean_rate : null,\n  z_co2: Number(zCo2.toFixed(2)),\n  z_rate: Number(zRate.toFixed(2)),\n  anomaly_status: anomalyStatus,\n  risk_adjust: riskAdjust,\n  risk_score: riskScore,\n  pred_request: {\n    action_level: riskScore >= 8 ? 3 : (riskScore >= 6 ? 2 : (riskScore >= 4 ? 1 : 0)),\n    fan_offset_pct: riskScore >= 8 ? 25 : (riskScore >= 6 ? 15 : (riskScore >= 4 ? 8 : 0)),\n    note: `v6_${confLevel}`\n  }\n};\n\nflow.set('predictive_last', rec);\nmsg.log_type = 'predictive';\nmsg.log_record = rec;\n\n// 6. IÅ¡vestis 2: AI Gateway (Telegram praneÅ¡imas)\nlet msgAi = null;\nif (riskScore >= 6 && occupied) {\n  msgAi = {\n    chatId: Number(env.get(\"MY_TELEGRAM_ID\")),\n    ai_reply: true,\n    topic: 'predictive_alert',\n    payload: `âš ï¸ *AukÅ¡ta COâ‚‚ rizika: ${riskScore}/10*\\n` +\n      `PrognozÄ—: ${co2} â†’ ${f30} ppm (+30min).\\n` +\n      `Nuokrypis: Z-Rate ${zRate.toFixed(1)} (${anomalyStatus}).`\n  };\n}\n\n// Statuso rodymas Node-RED interfeise\nnode.status({\n  fill: riskScore >= 6 ? \"red\" : (confActionable ? \"green\" : \"blue\"),\n  shape: \"dot\",\n  text: `R:${riskScore} | Zc:${zCo2.toFixed(1)} | Zr:${zRate.toFixed(1)} | ${confLevel}`\n});\n\nreturn [msg, msgAi];",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 460,
        "y": 80,
        "wires": [
            [
                "d648fd167e97409a"
            ],
            [
                "41d623eee9cf4a88"
            ]
        ]
    },
    {
        "id": "5cfb2ecb141c43b2",
        "type": "link out",
        "z": "b25879043e0541ce",
        "name": "Log Out: Predictive",
        "mode": "link",
        "links": [
            "06fe04c8af0fb417"
        ],
        "x": 885,
        "y": 80,
        "wires": []
    },
    {
        "id": "41d623eee9cf4a88",
        "type": "link out",
        "z": "b25879043e0541ce",
        "name": "AI Out: Reply",
        "mode": "link",
        "links": [
            "2c73cea35fecb95c"
        ],
        "x": 605,
        "y": 140,
        "wires": []
    },
    {
        "id": "9932214e75174d30",
        "type": "link in",
        "z": "b25879043e0541ce",
        "name": "AI In: Predictive",
        "links": [
            "567de76b7fee6e80"
        ],
        "x": 315,
        "y": 140,
        "wires": [
            [
                "ee3abf6809b74c04"
            ]
        ]
    },
    {
        "id": "ee3abf6809b74c04",
        "type": "function",
        "z": "b25879043e0541ce",
        "name": "AI Handler (Predictive)",
        "func": "const last = flow.get('predictive_last') || {};\nconst matrix = global.get('prediction_matrix') || {};\nconst text = String(msg.user_text || '').toLowerCase();\n\nfunction fmtMatrix(m) {\n  if (!m.data) return \"Matrica dar nesugeneruota. Laukite naktinio mokymosi (03:05).\";\n  const ci = m.confidence_info || {};\n  return `ğŸ“Š *Modelio bÅ«sena (v${m.model_ver})*\\n` +\n    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n` +\n    `ğŸ“… *Mokymosi laikas:* ${m.training_days_actual} d. (max 45)\\n` +\n    `ğŸ“ˆ *Tikslumas:* ${ci.level?.toUpperCase()} (${ci.is_live_ready ? 'âœ… LIVE READY' : 'âš ï¸ SHADOW ONLY'})\\n` +\n    `ğŸ•’ *Sugeneruota:* ${new Date(m.generated_at).toLocaleString('lt-LT')}\\n` +\n    `ğŸ’¡ _Sprendimai remiasi ${Object.keys(m.data).length} elgsenos bucket'Å³._`;\n}\n\nfunction fmtShadow(u) {\n  if (!u.ts) return 'Predictive: dar nÄ—ra Ä¯raÅ¡Å³.';\n  return `ğŸ§  *Rizika:* ${u.risk_score}/10 (Adjust: +${u.risk_adjust})\\n` +\n    `ğŸ’¨ *COâ‚‚:* ${u.co2} â†’ ${u.co2_f_30} (+30m)\\n` +\n    `ğŸ¯ *Z-Score:* COâ‚‚: ${u.z_co2} | Rate: ${u.z_rate}\\n` +\n    `ğŸ“œ *Statusas:* ${u.anomaly_status?.toUpperCase()}`;\n}\n\nlet reply;\nif (text.includes('matrix')) reply = fmtMatrix(matrix);\nelse if (text.includes('shadow') || text.includes('risk') || text.includes('rizika')) reply = fmtShadow(last);\nelse reply = \"Klausk: `/shadow` (rizika) arba `/matrix` (modelio branda).\";\n\nmsg.ai_reply = true;\nmsg.payload = { chatId: msg.chatId, text: reply, parse_mode: 'Markdown' };\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 460,
        "y": 140,
        "wires": [
            [
                "41d623eee9cf4a88"
            ]
        ]
    },
    {
        "id": "d648fd167e97409a",
        "type": "function",
        "z": "b25879043e0541ce",
        "name": "Cache: Save Last Shadow",
        "func": "// IÅ¡saugom paskutinÄ¯ predictive Ä¯raÅ¡Ä… AI uÅ¾klausoms\nif (msg && msg.log_record && typeof msg.log_record === 'object') {\n  flow.set('predictive_last', msg.log_record);\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 720,
        "y": 80,
        "wires": [
            [
                "5cfb2ecb141c43b2"
            ]
        ]
    },
    {
        "id": "learner_scheduler",
        "type": "inject",
        "z": "b25879043e0541ce",
        "name": "Scheduler: Daily Learner (03:05)",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "05 03 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "train_matrix",
        "payloadType": "date",
        "x": 160,
        "y": 220,
        "wires": [
            [
                "learner_build_cmd"
            ]
        ]
    },
    {
        "id": "learner_build_cmd",
        "type": "function",
        "z": "b25879043e0541ce",
        "name": "Build Training Command (45d)",
        "func": "/**\n * Build Training Command v6.1 (Bugfixed)\n * - Naudoja Bash ciklÄ… datÅ³ generavimui (maÅ¾iau apkrauna Node-RED)\n * - UÅ¾tikrina teisingÄ… kintamÅ³jÅ³ eskapinimÄ…\n * - Tikrina failÅ³ egzistavimÄ… prieÅ¡ skaitant\n */\n\nconst baseDir = '/data/logs/komfovent';\nconst maxDays = msg.training_window_max_days || 45;\n\n// JS suformuoja Å¡variÄ… komandÄ… Bash'ui\n// Naudojame $i ir $d kaip Bash kintamuosius, o maxDays Ä¯terpiame iÅ¡ JS\nconst bashCmd = `\nfor i in $(seq 1 ${maxDays}); do \n    d=$(date -d \"-$i days\" +%F); \n    f=\"${baseDir}/komfovent_telemetry_$d.jsonl\"; \n    if [ -f \"$f\" ]; then \n        cat \"$f\"; \n    fi; \ndone | jq -c '{ts, occupied, co2, rate, dow}'\n`.replace(/\\n/g, \" \").trim();\n\nmsg.payload = `bash -lc \"${bashCmd.replace(/\"/g, '\\\\\"')}\"`;\n\nnode.status({ fill: \"blue\", shape: \"ring\", text: `Training window: ${maxDays}d` });\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 220,
        "wires": [
            [
                "learner_exec"
            ]
        ]
    },
    {
        "id": "learner_exec",
        "type": "exec",
        "z": "b25879043e0541ce",
        "command": "",
        "addpay": "payload",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "Exec: Read Logs",
        "x": 710,
        "y": 200,
        "wires": [
            [
                "learner_process_stats"
            ],
            [],
            []
        ]
    },
    {
        "id": "learner_process_stats",
        "type": "function",
        "z": "b25879043e0541ce",
        "name": "Process Matrix Stats (60m)",
        "func": "// SkaiÄiuojami statistiniai rodikliai matricos formavimui.\n// PATAISYMAS: model_ver ir schema_ver imami iÅ¡ globalios atminties.\n\nfunction welfordInit() { return { n: 0, mean: 0, M2: 0 }; }\nfunction welfordAdd(st, x) {\n  st.n += 1;\n  const delta = x - st.mean;\n  st.mean += delta / st.n;\n  const delta2 = x - st.mean;\n  st.M2 += delta * delta2;\n}\nfunction welfordStd(st) {\n  if (st.n < 2) return 0;\n  return Math.sqrt(st.M2 / (st.n - 1)); // Sample Std Dev\n}\n\nconst schema_ver = global.get('schema_ver');\nconst model_ver = global.get('model_ver');\n\nlet lines = String(msg.payload || '').split('\\n').filter(Boolean);\nlet matrix = {};\nlet uniqueDays = new Set();\n\nfor (const line of lines) {\n  let d;\n  try { d = JSON.parse(line); } catch (e) { continue; }\n  if (!d.ts || typeof d.occupied === 'undefined' || !d.dow) continue;\n\n  const dayStr = String(d.ts).split('T')[0];\n  if (dayStr) uniqueDays.add(dayStr);\n\n  const t = new Date(d.ts);\n  const bucket = Math.floor((t.getHours() * 60 + t.getMinutes()) / 60);\n  const key = `${d.dow}_${bucket}_${String(Boolean(d.occupied))}`;\n\n  if (!matrix[key]) {\n    matrix[key] = { co2: welfordInit(), rate: welfordInit(), n: 0 };\n  }\n\n  matrix[key].n += 1;\n  if (Number.isFinite(Number(d.co2))) welfordAdd(matrix[key].co2, Number(d.co2));\n  if (Number.isFinite(Number(d.rate))) welfordAdd(matrix[key].rate, Number(d.rate));\n}\n\nconst trainingDays = uniqueDays.size;\nlet conf = 'low';\nif (trainingDays >= 30) conf = 'very_high';\nelse if (trainingDays >= 16) conf = 'high';\nelse if (trainingDays >= 8) conf = 'medium';\n\nlet data = {};\nfor (const k of Object.keys(matrix)) {\n  const m = matrix[k];\n  data[k] = {\n    mean_co2: Number(m.co2.mean.toFixed(2)),\n    std_co2: Number(welfordStd(m.co2).toFixed(2)),\n    mean_rate: Number(m.rate.mean.toFixed(2)),\n    std_rate: Number(welfordStd(m.rate).toFixed(2)),\n    n: m.n\n  };\n}\n\nconst finalMatrix = {\n  schema_ver,\n  model_ver,\n  bucket_minutes: 60,\n  generated_at: new Date().toISOString(),\n  training_days_actual: trainingDays,\n  confidence_info: {\n    level: conf,\n    is_live_ready: (trainingDays >= 16)\n  },\n  data\n};\n\nglobal.set('prediction_matrix', finalMatrix);\nmsg.payload = JSON.stringify(finalMatrix);\nmsg.filename = '/data/state/komfovent/prediction_matrix.json';\n\nnode.status({ fill: 'blue', shape: 'dot', text: `v${model_ver} | Days: ${trainingDays}` });\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 740,
        "y": 260,
        "wires": [
            [
                "learner_save_file"
            ]
        ]
    },
    {
        "id": "learner_save_file",
        "type": "file",
        "z": "b25879043e0541ce",
        "name": "Save Matrix",
        "filename": "filename",
        "filenameType": "msg",
        "appendNewline": false,
        "createDir": true,
        "overwriteFile": "true",
        "encoding": "utf8",
        "x": 930,
        "y": 200,
        "wires": [
            []
        ]
    }
]